<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode v2.2 (Menu & Save As)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --line-number-color: #858585;
            --header-height: 40px;
            --menu-bg: #2d2d2d;
            --menu-hover: #094771;
            
            --editor-font: 'Consolas', 'Monaco', 'Courier New', monospace;
            --editor-size: 14px;
            --editor-line-height: 20px; 
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color); color: var(--text-color);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; font-family: -apple-system, sans-serif;
        }

        /* HEADER */
        header {
            height: var(--header-height); background: #333;
            display: flex; align-items: center; padding: 0 10px;
            justify-content: space-between; border-bottom: 1px solid #111; user-select: none;
            z-index: 20;
        }
        .controls { display: flex; gap: 6px; position: relative; }
        .logo { font-weight: bold; color: white; margin-right: 10px; font-size: 14px;}
        
        .btn {
            border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; color: white; 
            font-size: 11px; display: flex; align-items: center; transition: 0.2s; white-space: nowrap;
        }
        .btn-blue { background: var(--accent-color); } .btn-blue:hover{background:#0062a3;}
        .btn-green { background: #238636; } .btn-green:hover{background:#2ea043;}
        .btn-gray { background: #444; } .btn-gray:hover{background:#555;}
        
        /* Dropdown Menu Style */
        .dropdown {
            position: absolute;
            top: 30px;
            right: 0;
            background: #252526;
            border: 1px solid #454545;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column;
            min-width: 150px;
            z-index: 100;
        }
        
        .dropdown.show { display: flex; }

        .dropdown-item {
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            color: #ccc;
            border-bottom: 1px solid #333;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: var(--menu-hover); color: white; }

        /* MAIN */
        .workspace { display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px); }

        .sidebar {
            width: 250px; background: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 10px 15px; font-size: 11px; font-weight: bold; color: #aaa;
            text-transform: uppercase; background: #2b2b2c; display: flex; justify-content: space-between;
        }
        .file-list { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .file-item {
            padding: 4px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: #ccc; cursor: pointer; border-left: 3px solid transparent;
        }
        .file-item:hover { background: #2a2d2e; }
        .file-item.active { background: #37373d; border-left-color: var(--accent-color); color: #fff; }
        
        .del-btn { opacity: 0; color: #666; font-weight: bold; margin-left: 5px; }
        .file-item:hover .del-btn { opacity: 1; } .del-btn:hover { color: #f44; }

        .editor-container {
            flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-color); min-width: 0;
        }
        .tab-bar { height: 35px; background: #252526; display: flex; align-items: center; }
        .tab { 
            padding: 0 15px; height: 100%; display: flex; align-items: center;
            background: #1e1e1e; font-size: 13px; border-top: 2px solid var(--accent-color);
        }

        /* EDITOR */
        .code-wrapper {
            flex: 1; display: flex; position: relative; overflow: hidden; 
        }
        .gutter {
            width: 45px; flex-shrink: 0; background: #1e1e1e; color: var(--line-number-color);
            text-align: right; border-right: 1px solid #333; user-select: none; 
            overflow: hidden; padding-top: 10px; box-sizing: border-box;
        }
        .line-num {
            height: var(--editor-line-height); line-height: var(--editor-line-height);
            font-family: var(--editor-font); font-size: var(--editor-size); padding-right: 8px;
        }
        textarea#editor {
            flex: 1; background: transparent; border: none; outline: none; resize: none;
            color: var(--text-color); padding: 10px; box-sizing: border-box;
            font-family: var(--editor-font); font-size: var(--editor-size); line-height: var(--editor-line-height);
            tab-size: 4; white-space: pre; overflow-x: scroll; overflow-y: scroll; 
        }
        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; }

        footer { height: 25px; background: var(--accent-color); display: flex; align-items: center; padding: 0 15px; color: white; font-size: 11px; }

        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:99;}
        .modal { background: #252526; padding: 20px; width: 300px; border:1px solid #444; text-align:center;}
        .modal input { width: 90%; padding: 5px; margin: 10px 0; background: #3c3c3c; border: 1px solid #555; color: #fff;}
    </style>
</head>
<body>

<header>
    <div class="logo">Roode <span style="font-size:10px;opacity:0.5">2.2</span></div>
    <div class="controls">
        <button class="btn btn-blue" onclick="selFolder()">üìÇ –ü–∞–ø–∫–∞</button>
        <button class="btn btn-green" onclick="showNew()">‚ûï</button>
        <button class="btn btn-gray" onclick="save()">üíæ Save All</button>
        <button class="btn btn-gray" onclick="selFiles()">üìÑ –§–∞–π–ª—ã</button>
        
        <!-- –ö–ù–û–ü–ö–ê –ú–ï–ù–Æ -->
        <button class="btn btn-gray" style="font-size: 14px; font-weight: bold; padding: 2px 10px;" onclick="toggleMenu(event)">‚Ä¢‚Ä¢‚Ä¢</button>
        
        <!-- –í–´–ü–ê–î–ê–Æ–©–ï–ï –ú–ï–ù–Æ -->
        <div id="mainMenu" class="dropdown">
            <div class="dropdown-item" onclick="saveAs()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫...</div>
            <div class="dropdown-item" onclick="exportTxt()">–°–∫–∞—á–∞—Ç—å .txt</div>
            <div class="dropdown-item" style="color:#ff6b6b" onclick="closeAll()">–ó–∞–∫—Ä—ã—Ç—å –≤—Å—ë</div>
        </div>
    </div>
</header>

<div class="workspace">
    <div class="sidebar">
        <div class="sidebar-header">
            <span id="labelHeader">–ü–†–û–í–û–î–ù–ò–ö</span>
            <span style="cursor:pointer" onclick="listRender()">‚Üª</span>
        </div>
        <ul id="listUI" class="file-list"></ul>
    </div>
    <div class="editor-container">
        <div class="tab-bar"><div class="tab" id="tabInfo">...</div></div>
        
        <div class="code-wrapper">
            <div id="gutter" class="gutter"></div>
            <textarea id="editor" spellcheck="false" placeholder="// –ú–µ–Ω—é —Å —Ç—Ä–µ–º—è —Ç–æ—á–∫–∞–º–∏ —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É -> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫..."></textarea>
        </div>
    </div>
</div>

<footer><div id="msg">–ì–æ—Ç–æ–≤</div></footer>

<div class="overlay" id="mod"><div class="modal">
    <h3>–ù–æ–≤—ã–π —Ñ–∞–π–ª</h3><input id="fname"><br>
    <button class="btn btn-blue" onclick="createFile()">OK</button>
    <button class="btn btn-gray" onclick="document.getElementById('mod').style.display='none'">X</button>
</div></div>

<script>
    // VARS
    let fHandle = null, fileH = null, isDir = false;
    let filesCache = [];
    let projectMemory = {}; 

    const ed = document.getElementById('editor');
    const gut = document.getElementById('gutter');
    const ui = document.getElementById('listUI');
    const msg = document.getElementById('msg');
    const tab = document.getElementById('tabInfo');
    const label = document.getElementById('labelHeader');
    const menu = document.getElementById('mainMenu');

    // -- NUMBERS --
    function updateLines() {
        const linesCount = ed.value.split('\n').length;
        let html = '';
        for(let i=0; i < linesCount; i++){ html += `<div class="line-num">${i+1}</div>`; }
        gut.innerHTML = html;
    }
    ed.addEventListener('input', () => {
        updateLines();
        if(!isDir && fileH) projectMemory[fileH.name] = ed.value;
    });
    ed.addEventListener('scroll', () => { gut.scrollTop = ed.scrollTop; });
    ed.addEventListener('keydown', ()=> setTimeout(updateLines,0));

    // -- MENU LOGIC --
    function toggleMenu(e) {
        e.stopPropagation();
        menu.classList.toggle('show');
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
    window.addEventListener('click', () => {
        if (menu.classList.contains('show')) menu.classList.remove('show');
    });

    // 1. SAVE AS (–°–û–•–†–ê–ù–ò–¢–¨ –ö–ê–ö)
    async function saveAs() {
        try {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const options = {
                types: [{
                    description: 'RuPL Source File',
                    accept: {'text/plain': ['.PRSH', '.PRSHX']}
                }],
                suggestedName: fileH ? 'copy_' + fileH.name : 'Untitled.PRSH'
            };
            
            // –í—ã–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥
            const newHandle = await window.showSaveFilePicker(options);
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª
            const writable = await newHandle.createWritable();
            await writable.write(ed.value);
            await writable.close();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–π —Ñ–∞–π–ª
            notify(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫: ${newHandle.name}`);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º—É, –µ—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            if(!isDir) {
                filesCache.push(newHandle);
                projectMemory[newHandle.name] = ed.value;
            }
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π
            load(newHandle);
            listRender(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –Ω–æ–≤—ã–π —Ñ–∞–π–ª –ø–æ—è–≤–∏–ª—Å—è (–µ—Å–ª–∏ —Ä–µ–∂–∏–º —Ñ–∞–π–ª–æ–≤)

        } catch (err) {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –æ—Ç–º–µ–Ω—É, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            console.log('Save As Cancelled');
        }
    }

    // 2. EXPORT TXT
    function exportTxt() {
        const blob = new Blob([ed.value], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (fileH ? fileH.name : 'code') + '.txt';
        a.click();
        notify("–°–∫–∞—á–∞–Ω–æ .txt");
    }
    
    // 3. CLOSE ALL
    function closeAll() {
        if(!confirm("–ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã? –ù–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –û–ó–£ –ø—Ä–æ–ø–∞–¥—É—Ç.")) return;
        projectMemory = {}; filesCache = []; fHandle = null; isDir = false;
        label.textContent = "–ü–†–û–í–û–î–ù–ò–ö";
        resetEd(); listRender();
    }


    // -- LOADERS --
    async function selFolder() {
        try {
            fHandle = await window.showDirectoryPicker();
            isDir = true; label.textContent = fHandle.name.toUpperCase();
            projectMemory = {}; filesCache = [];
            resetEd(); listRender();
        } catch(e){}
    }

    async function selFiles() {
        try {
            filesCache = await window.showOpenFilePicker({multiple:true, types:[{description:'Code',accept:{'text/plain':['.prsh','.prshx','.txt']}}]});
            isDir = false; fHandle = null; label.textContent = "–§–ê–ô–õ–´ –í –ü–ê–ú–Ø–¢–ò";
            resetEd(); projectMemory = {};
            for (let h of filesCache) { const f = await h.getFile(); projectMemory[h.name] = await f.text(); }
            listRender();
        } catch(e){}
    }

    function resetEd() { fileH = null; ed.value = ''; tab.textContent = "---"; updateLines(); }

    async function listRender() {
        ui.innerHTML = '';
        let list = [];
        if(isDir && fHandle) {
            for await (const [n, h] of fHandle.entries()) {
                if(h.kind==='file' && n.toUpperCase().match(/\.(PRSH|PRSHX|TXT)$/)) list.push(h);
            }
        } else if(!isDir) list = [...filesCache];

        list.sort((a,b)=>a.name.localeCompare(b.name)).forEach(h => {
            const li = document.createElement('li');
            li.className='file-item';
            if(fileH && fileH.name===h.name) li.classList.add('active');
            const ico = h.name.match(/X$/i)?'üß©':'üìÑ';
            li.innerHTML = `<span>${ico} ${h.name}</span><span class="del-btn">üóë</span>`;
            li.onclick = (e) => { if(!e.target.className.includes('del')) load(h); };
            li.querySelector('.del-btn').onclick = async()=>{
                if(!confirm('–£–±—Ä–∞—Ç—å?'))return;
                if(isDir) await fHandle.removeEntry(h.name);
                else { filesCache = filesCache.filter(x=>x!=h); delete projectMemory[h.name]; }
                if(fileH && fileH.name == h.name) resetEd();
                listRender();
            };
            ui.appendChild(li);
        });
    }

    async function load(h) {
        fileH = h;
        const items = document.querySelectorAll('.file-item');
        items.forEach(i => i.classList.remove('active'));
        listRender();
        if(isDir) { const f = await h.getFile(); ed.value = await f.text(); } 
        else { ed.value = projectMemory[h.name] || ""; }
        tab.textContent = h.name; msg.textContent = h.name; updateLines();
    }

    // NORMAL SAVE (Overwrite)
    async function save() {
        if(isDir) {
            if(!fileH) return alert('–§–∞–π–ª –Ω–µ –æ—Ç–∫—Ä—ã—Ç');
            const w = await fileH.createWritable(); await w.write(ed.value); await w.close();
            notify(`–°–æ—Ö—Ä–∞–Ω–µ–Ω: ${fileH.name}`);
        } else {
            if(filesCache.length === 0) return alert("–ù–µ—Ç —Ñ–∞–π–ª–æ–≤");
            if(fileH) projectMemory[fileH.name] = ed.value;
            try {
                let c = 0;
                for(let h of filesCache) {
                    const ct = projectMemory[h.name];
                    if(ct!==undefined) { const w = await h.createWritable(); await w.write(ct); await w.close(); c++; }
                }
                notify(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${c}`);
            } catch(e) { alert("Err: " + e.message); }
        }
    }

    function notify(txt) { msg.textContent = txt; setTimeout(()=>msg.textContent='–ì–æ—Ç–æ–≤', 3000); }
    function showNew(){ if(!isDir) return alert('–ù—É–∂–Ω–∞ –ø–∞–ø–∫–∞'); document.getElementById('mod').style.display='block'; }
    async function createFile(){
        let n = document.getElementById('fname').value; if(!n) return;
        if(!n.match(/\./)) n+='.PRSH';
        const nh = await fHandle.getFileHandle(n,{create:true});
        const w = await nh.createWritable(); await w.write('–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {\n\n}'); await w.close();
        document.getElementById('mod').style.display='none'; listRender(); load(nh);
    }
    document.addEventListener('keydown', e=>{if(e.ctrlKey&&e.key=='s'){e.preventDefault();save()}});
</script>
</body>
</html>
