<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode - RuPL Editor (Fixed Sync)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --gutter-text: #858585;
            --text-color: #cccccc;
            --accent-color: #007acc;
            --header-height: 40px;
            --font-family: 'Consolas', 'Courier New', monospace;
            --font-size: 14px;
            --line-height: 20px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ */
        }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        header {
            height: var(--header-height); background-color: #3c3c3c;
            display: flex; align-items: center; padding: 0 15px;
            justify-content: space-between; user-select: none;
        }

        .controls button {
            background-color: var(--accent-color); border: none; color: white;
            padding: 5px 12px; margin-left: 10px; border-radius: 3px; cursor: pointer;
        }
        .controls button.secondary { background-color: #444; }

        .workspace {
            display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px);
        }

        .sidebar {
            width: 250px; background-color: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        
        .file-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .file-item { padding: 5px 10px; cursor: pointer; display: flex; justify-content: space-between; color:#bbb;}
        .file-item:hover { background: #2a2d2e; color: #fff;}
        .file-item.active { background: #37373d; border-left: 3px solid var(--accent-color);}

        /* –†–ï–î–ê–ö–¢–û–† - –û–ë–û–õ–û–ß–ö–ê */
        .editor-container {
            flex: 1; display: flex; flex-direction: column; position: relative;
            background: var(--bg-color);
        }

        .tab-bar { height: 35px; background: #2d2d2d; display: flex; align-items: center; }
        .tab { padding: 0 15px; height: 100%; display: flex; align-items: center; background: var(--bg-color); color: #fff; font-size: 13px; border-top: 1px solid var(--accent-color); }

        /* –í–ê–ñ–ù–û: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏ –Ω–æ–º–µ—Ä–æ–≤ */
        .code-area {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden; /* –°–∫—Ä–æ–ª–ª–∏—Ç textarea, –Ω–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –æ–±—â–∏–π */
        }

        /* –ö–æ–ª–æ–Ω–∫–∞ –Ω–æ–º–µ—Ä–æ–≤ */
        .gutter {
            width: 50px;
            background: var(--sidebar-color);
            color: var(--gutter-text);
            text-align: right;
            border-right: 1px solid #444;
            user-select: none;
            overflow: hidden; /* –°–∫—Ä–æ–ª–ª–∏—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ —á–µ—Ä–µ–∑ JS */
            padding-top: 10px;
            box-sizing: border-box;
        }

        .line-number {
            font-size: var(--font-size);
            font-family: var(--font-family);
            line-height: var(--line-height);
            padding-right: 8px;
            box-sizing: border-box;
            /* –í—ã—Å–æ—Ç–∞ –∑–∞–¥–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º */
        }

        /* –°–∞–º–æ –ø–æ–ª–µ –≤–≤–æ–¥–∞ */
        textarea#editor {
            flex: 1;
            background: transparent;
            color: #d4d4d4;
            border: none;
            resize: none;
            padding: 10px; /* –û—Ç—Å—Ç—É–ø—ã –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å gutter-–æ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            font-family: var(--font-family);
            font-size: var(--font-size);
            line-height: var(--line-height);
            outline: none;
            white-space: pre-wrap; /* –ü–µ—Ä–µ–Ω–æ—Å —Å–ª–æ–≤ –≤–∫–ª—é—á–µ–Ω */
            overflow-y: scroll;
            overflow-x: hidden;
            tab-size: 4;
            box-sizing: border-box; /* –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ */
            z-index: 2;
        }

        /* –°–ö–†–´–¢–´–ô –ë–õ–û–ö –î–õ–Ø –ò–ó–ú–ï–†–ï–ù–ò–ô (–¢–µ–Ω—å) */
        /* –û–Ω —Ç–æ—á–Ω–æ –∫–æ–ø–∏—Ä—É–µ—Ç —Å—Ç–∏–ª–∏ textarea, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –≤—ã—Å–æ—Ç—É –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
        #size-calculator {
            visibility: hidden;
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: calc(100% - 250px - 20px); /* –®–∏—Ä–∏–Ω–∞ textarea (100% - sidebar - padding) –≥—Ä—É–±–æ, –Ω–æ —Ç–æ—á–Ω–µ–µ —á–µ—Ä–µ–∑ JS */
            font-family: var(--font-family);
            font-size: var(--font-size);
            line-height: var(--line-height);
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 10px; /* –¢–µ –∂–µ –ø–∞–¥–¥–∏–Ω–≥–∏ —á—Ç–æ –∏ —É textarea */
            box-sizing: border-box;
        }

        footer { height: 25px; background: var(--accent-color); display: flex; align-items: center; padding: 0 15px; color: white; font-size: 12px; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ –º–µ–ª–æ—á–∏ */
        .icon { margin-right:5px;}
        .delete-btn { opacity: 0; color: #888; }
        .file-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: red; font-weight: bold; }
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:99;}
        .modal { background:#252526; padding:20px; border-radius:5px; text-align:center; box-shadow:0 0 10px #000;}
        .modal input { background: #333; color: white; border:1px solid #555; padding:5px; width:80%;}
    </style>
</head>
<body>

<header>
    <div style="color:white; font-weight:bold;">Roode <small>v1.3 Fix</small></div>
    <div class="controls">
        <button class="secondary" onclick="openFolder()">üìÇ –ü–∞–ø–∫–∞</button>
        <button class="secondary" onclick="newFileUI()">üìÑ –§–∞–π–ª</button>
        <button onclick="saveFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</header>

<div class="workspace">
    <!-- –°–ê–ô–î–ë–ê–† -->
    <div class="sidebar">
        <div style="padding:10px; color:#aaa; font-size:11px; font-weight:bold;">–ü–†–û–í–û–î–ù–ò–ö <span onclick="listFiles()" style="cursor:pointer; float:right;">‚Üª</span></div>
        <ul id="fileList" class="file-list"></ul>
    </div>

    <!-- –†–ï–î–ê–ö–¢–û–† -->
    <div class="editor-container">
        <div class="tab-bar">
            <div class="tab" id="currentFile">...</div>
        </div>
        
        <div class="code-area">
            <!-- –°–ª–µ–≤–∞ —Ü–∏—Ñ—Ä—ã -->
            <div id="gutter" class="gutter">
                <div class="line-number">1</div>
            </div>

            <!-- –ü–æ —Ü–µ–Ω—Ç—Ä—É –∫–æ–¥ -->
            <textarea id="editor" spellcheck="false" placeholder="–ü–∏—à–∏ –∫–æ–¥ –∑–¥–µ—Å—å..."></textarea>
            
            <!-- –ù–µ–≤–∏–¥–∏–º—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã—Å–æ—Ç—ã -->
            <div id="size-calculator"></div>
        </div>
    </div>
</div>

<footer>
    <div id="status">–ì–æ—Ç–æ–≤</div>
</footer>

<div class="overlay" id="modalUI">
    <div class="modal">
        <h3>–ù–æ–≤—ã–π —Ñ–∞–π–ª</h3>
        <input id="filename" placeholder="Name.PRSH">
        <br><br>
        <button onclick="createFileExec()">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="secondary" onclick="document.getElementById('modalUI').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    let dirHandle, fileHandle;
    const editor = document.getElementById('editor');
    const gutter = document.getElementById('gutter');
    const shadow = document.getElementById('size-calculator'); // –¢–µ–Ω–µ–≤–æ–π –±–ª–æ–∫

    // ===== –Ø–î–†–û: –õ–û–ì–ò–ö–ê –ù–£–ú–ï–†–ê–¶–ò–ò –ò –í–´–°–û–¢–´ –°–¢–†–û–ö =====
    function updateLineNumbers() {
        const text = editor.value;
        const lines = text.split('\n'); // –†–∞–∑–±–∏–≤–∞–µ–º –∫–æ–¥ –Ω–∞ –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É —Ç–µ–Ω–µ–≤–æ–≥–æ –±–ª–æ–∫–∞ —Å —Ä–µ–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        // –í–∞–∂–Ω–æ –≤—ã—á–µ—Å—Ç—å –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        shadow.style.width = editor.clientWidth + 'px'; 
        shadow.innerHTML = ''; // –ß–∏—Å—Ç–∏–º —Ç–µ–Ω—å

        let htmlNumbers = '';

        // –ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
        lines.forEach((lineText, index) => {
            // 1. –°–æ–∑–¥–∞–µ–º "–∫—É—Å–æ—á–µ–∫" —Ç–µ–∫—Å—Ç–∞ –≤ —Å–∫—Ä—ã—Ç–æ–º –±–ª–æ–∫–µ
            const div = document.createElement('div');
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è, –≤—Å—Ç–∞–≤–∏–º –ø—Ä–æ–±–µ–ª, —á—Ç–æ–±—ã —É –Ω–µ–µ –±—ã–ª–∞ –≤—ã—Å–æ—Ç–∞
            div.textContent = lineText || ' '; 
            // –°—Ç–∏–ª–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å (padding –∏ border –Ω–µ –Ω—É–∂–Ω—ã —Ç—É—Ç, —Ç–∞–∫ –∫–∞–∫ —É container padding)
            div.style.lineHeight = '20px';
            
            shadow.appendChild(div);

            // 2. –ò–∑–º–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –ø–æ–ª—É—á–∏–≤—à–µ–≥–æ—Å—è –±–ª–æ–∫–∞ (—Å —É—á–µ—Ç–æ–º –ø–µ—Ä–µ–Ω–æ—Å–æ–≤)
            const height = div.offsetHeight;

            // 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ —Å —ç—Ç–æ–π –≤—ã—Å–æ—Ç–æ–π
            htmlNumbers += `<div class="line-number" style="height:${height}px">${index + 1}</div>`;
        });

        // 4. –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —Ü–∏—Ñ—Ä
        gutter.innerHTML = htmlNumbers;
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
    editor.addEventListener('input', updateLineNumbers);
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª (–∫—Ä—É—Ç–∏—à—å —Ç–µ–∫—Å—Ç - –∫—Ä—É—Ç—è—Ç—Å—è —Ü–∏—Ñ—Ä—ã)
    editor.addEventListener('scroll', () => {
        gutter.scrollTop = editor.scrollTop;
    });

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –º–æ–∂–µ—Ç —Å–¥–≤–∏–Ω—É—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å–ª–æ–≤
    window.addEventListener('resize', updateLineNumbers);
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    editor.value = `–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {
    
    // –ü—Ä–∏–º–µ—Ä –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏:
    // –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—Å—Ç–æ–ª—å–∫–æ –¥–ª–∏–Ω–Ω–∞—è, —á—Ç–æ –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏—Å—å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ, –∏ –Ω–æ–º–µ—Ä —Å–ª–µ–≤–∞ (—Ü–∏—Ñ—Ä–∞ 4) –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å –≤—ã—à–µ (–∑–∞–Ω—è—Ç—å 2 –∏–ª–∏ 3 —Å—Ç—Ä–æ–∫–∏), —á—Ç–æ–±—ã —Ü–∏—Ñ—Ä–∞ 5 –Ω–µ –Ω–∞–ø–æ–ª–∑–ª–∞ –Ω–∞ —Ç–µ–∫—Å—Ç. –ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ, –≤–ø–∏—Å–∞–≤ —Å—é–¥–∞ –º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

}`;
    setTimeout(updateLineNumbers, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞



    // ===== –§–ê–ô–õ–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê =====
    async function openFolder() {
        try {
            dirHandle = await window.showDirectoryPicker();
            document.getElementById('status').innerText = '–ü–∞–ø–∫–∞: ' + dirHandle.name;
            await listFiles();
        } catch(e) {}
    }

    async function listFiles() {
        if(!dirHandle) return;
        const list = document.getElementById('fileList');
        list.innerHTML = '';
        for await (const [key, val] of dirHandle.entries()) {
            if(val.kind === 'file' && (key.endsWith('.PRSH') || key.endsWith('.PRSHX'))) {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `<span>üìÑ ${key}</span> <span class="delete-btn">üóë</span>`;
                
                // –ö–ª–∏–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é - –æ—Ç–∫—Ä—ã—Ç—å
                li.querySelector('span').onclick = () => openFile(val);
                
                // –ö–ª–∏–∫ –ø–æ –∫–æ—Ä–∑–∏–Ω–µ - —É–¥–∞–ª–∏—Ç—å
                li.querySelector('.delete-btn').onclick = (e) => {
                    e.stopPropagation();
                    if(confirm('–£–¥–∞–ª–∏—Ç—å ' + key + '?')) {
                        dirHandle.removeEntry(key);
                        setTimeout(listFiles, 500); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                        if(fileHandle && fileHandle.name == key) editor.value = ''; // –ß–∏—Å—Ç–∏–º, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
                    }
                }
                list.appendChild(li);
            }
        }
    }

    async function openFile(handle) {
        fileHandle = handle;
        const file = await handle.getFile();
        editor.value = await file.text();
        document.getElementById('currentFile').innerText = handle.name;
        updateLineNumbers(); // –ü–ï–†–ï–°–ß–ò–¢–ê–¢–¨ –°–¢–†–û–ö–ò
    }

    async function saveFile() {
        if(!fileHandle) return alert('–§–∞–π–ª –Ω–µ –æ—Ç–∫—Ä—ã—Ç');
        const code = editor.value.trim();
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª)
        if(!code.toLowerCase().startsWith('–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatgpt') || !code.includes('{') || !code.endsWith('}')) {
             if(!confirm('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ RuPL (–Ω—É–∂–Ω—ã {}). –°–æ—Ö—Ä–∞–Ω–∏—Ç—å?')) return;
        }
        
        const writable = await fileHandle.createWritable();
        await writable.write(editor.value);
        await writable.close();
        document.getElementById('status').innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
    }

    function newFileUI() { 
        if(!dirHandle) return alert('–û—Ç–∫—Ä–æ–π –ø–∞–ø–∫—É!');
        document.getElementById('modalUI').style.display='flex'; 
    }
    
    async function createFileExec() {
        let name = document.getElementById('filename').value;
        if(!name.match(/\.(PRSH|PRSHX)$/i)) name += '.PRSH';
        await dirHandle.getFileHandle(name, {create:true});
        document.getElementById('modalUI').style.display='none';
        listFiles();
    }
    
    // Ctrl+S
    document.addEventListener('keydown', e => {
        if(e.ctrlKey && e.key === 's') { e.preventDefault(); saveFile(); }
    });
</script>

</body>
</html>
