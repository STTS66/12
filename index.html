<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode Editor v1.9.1</title>
    <style>
        :root {
            /* === –ù–ê–°–¢–†–û–ô–ö–ò === */
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --line-number-color: #858585;
            --header-height: 40px; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ –≤—ã—Å–æ—Ç–∞ —à–∞–ø–∫–∏ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ */
            
            --editor-font: 'Consolas', 'Monaco', 'Courier New', monospace;
            --editor-size: 14px;
            --editor-line-height: 20px; 
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color); color: var(--text-color);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; font-family: -apple-system, sans-serif;
        }

        /* HEADER */
        header {
            height: var(--header-height); background: #333;
            display: flex; align-items: center; padding: 0 10px; /* –ú–µ–Ω—å—à–µ –æ—Ç—Å—Ç—É–ø —Å –∫—Ä–∞–µ–≤ */
            justify-content: space-between; border-bottom: 1px solid #111; user-select: none;
        }

        .logo { 
            font-weight: 700; color: #fff; letter-spacing: 0.5px; 
            font-size: 14px; white-space: nowrap; overflow: hidden; margin-right: 5px;
        }

        .controls { 
            display: flex; 
            gap: 4px; /* –ú–µ–Ω—å—à–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
            flex-shrink: 0; /* –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∂–∏–º–∞—Ç—å –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ */
        }

        /* –ö–û–ú–ü–ê–ö–¢–ù–´–ï –ö–ù–û–ü–ö–ò */
        .btn {
            border: none; 
            padding: 4px 10px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –≤–Ω—É—Ç—Ä–∏ */
            border-radius: 3px;
            cursor: pointer; 
            color: white; 
            font-size: 11px; /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç */
            font-weight: 500;
            white-space: nowrap; /* –¢–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è */
            display: flex; 
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        
        .btn-blue { background: var(--accent-color); }
        .btn-blue:hover { background: #0062a3; }
        
        /* –ó–µ–ª–µ–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è - –¥–ª—è –∑–∞–º–µ—Ç–Ω–æ—Å—Ç–∏ */
        .btn-green { background: #238636; border: 1px solid rgba(240,246,252,0.1); }
        .btn-green:hover { background: #2ea043; }

        .btn-gray { background: #444; }
        .btn-gray:hover { background: #555; }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–æ–π */
        .btn-icon { padding: 4px 8px; font-size: 14px; }

        .workspace { display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px); }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 12px 15px; font-size: 11px; font-weight: bold; color: #aaa;
            text-transform: uppercase; background: #2b2b2c; display: flex; justify-content: space-between;
        }
        .file-list { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .file-item {
            padding: 5px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: #ccc; cursor: pointer; border-left: 3px solid transparent;
        }
        .file-item:hover { background: #2a2d2e; color: #fff; }
        .file-item.active { background: #37373d; border-left-color: var(--accent-color); color: #fff; }
        .del-btn { opacity: 0; font-weight: bold; color: #777; padding: 0 5px;}
        .file-item:hover .del-btn { opacity: 1; }
        .del-btn:hover { color: #f44; }

        /* EDITOR WRAPPER */
        .editor-container {
            flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-color);
        }
        .tab-bar { height: 35px; background: #252526; display: flex; align-items: center; border-bottom: 1px solid #111; }
        .tab { 
            padding: 0 15px; height: 100%; display: flex; align-items: center;
            background: #1e1e1e; font-size: 13px; border-top: 2px solid var(--accent-color);
        }

        /* --- SYNC AREA --- */
        .code-wrapper {
            flex: 1; display: flex; position: relative; overflow: hidden;
        }

        .gutter {
            width: 50px; flex-shrink: 0;
            background: #1e1e1e; color: var(--line-number-color);
            text-align: right; border-right: 1px solid #333;
            user-select: none; padding-top: 10px;
            box-sizing: border-box; overflow: hidden;
        }

        .line-box {
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
            padding-right: 10px;
        }

        textarea#editor {
            flex: 1;
            background: transparent; border: none; outline: none; resize: none;
            color: var(--text-color);
            padding: 10px;
            box-sizing: border-box;
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
            tab-size: 4;
            white-space: pre-wrap; 
            overflow-wrap: break-word;   
            overflow-y: scroll; 
        }

        #ghost-calc {
            position: absolute; top: 0; left: 0; visibility: hidden; pointer-events: none; z-index: -99;
            background: red; 
            padding: 10px; box-sizing: border-box;
            white-space: pre-wrap; overflow-wrap: break-word;
            font-family: var(--editor-font); font-size: var(--editor-size); line-height: var(--editor-line-height);
        }

        footer { height: 25px; background: var(--accent-color); display: flex; align-items: center; padding: 0 15px; color: white; font-size: 11px; }

        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:999;}
        .modal { background: #252526; padding: 25px; width: 300px; border-radius: 5px; box-shadow: 0 10px 30px #000; border:1px solid #444; text-align:center;}
        .modal input { width: 100%; padding: 8px; margin: 15px 0; background: #3c3c3c; border: 1px solid #555; color: #fff; box-sizing: border-box; outline:none;}
    </style>
</head>
<body>

<header>
    <div class="logo">Roode <span style="font-weight:normal;opacity:0.5; font-size:10px;">v1.9.1</span></div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ —Å—Ç–∞–ª–∏ –º–µ–Ω—å—à–µ, –æ—Ç—Å—Ç—É–ø—ã –º–µ–Ω—å—à–µ, —Ç–µ–ø–µ—Ä—å –≤–ª–µ–∑–µ—Ç –≤—Å—ë -->
    <div class="controls">
        <button class="btn btn-blue" onclick="chooseFolder()" title="–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É">üìÇ –ü–∞–ø–∫–∞</button>
        <button class="btn btn-green" onclick="newFileAsk()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn btn-gray btn-icon" onclick="saveDoc()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
        <div style="width:1px; background:#444; height:18px; margin:0 2px;"></div>
        <!-- –ó–∞–º–µ–Ω–∞ "..." –Ω–∞ "–û—Ç–¥.–§–∞–π–ª—ã" -->
        <button class="btn btn-gray" onclick="chooseFiles()">üìÑ –û—Ç–¥.–§–∞–π–ª—ã</button>
    </div>
</header>

<div class="workspace">
    <div class="sidebar">
        <div class="sidebar-header">
            <span id="projTitle">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</span>
            <span style="cursor:pointer" onclick="render()">‚Üª</span>
        </div>
        <ul id="tree" class="file-list">
            <li style="padding:15px; text-align:center; color:#555;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>
        </ul>
    </div>

    <div class="editor-container">
        <div class="tab-bar">
            <div class="tab" id="tabTitle">–ü—É—Å—Ç–æ</div>
        </div>
        
        <div class="code-wrapper">
            <div id="gutter" class="gutter"></div>
            <textarea id="editor" spellcheck="false" placeholder="// –ü—Ä–∏–≤–µ—Ç! –í—ã–±–µ—Ä–∏ –ø–∞–ø–∫—É..."></textarea>
            <div id="ghost-calc"></div>
        </div>
    </div>
</div>

<footer>
    <div id="stat">–ì–æ—Ç–æ–≤</div>
</footer>

<div class="overlay" id="modal">
    <div class="modal">
        <h3 style="color:#ddd; margin:0">–ò–º—è —Ñ–∞–π–ª–∞</h3>
        <input id="fname" placeholder="script.PRSH" onkeydown="if(event.key==='Enter') createYes()">
        <button class="btn btn-blue" onclick="createYes()">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn btn-gray" onclick="document.getElementById('modal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    // VARS
    let folderH = null;
    let fileH = null;
    let isDir = false;
    let handlesCache = [];

    // DOM ELEMENTS
    const dom = {
        ed: document.getElementById('editor'),
        gut: document.getElementById('gutter'),
        gh: document.getElementById('ghost-calc'),
        list: document.getElementById('tree'),
        tit: document.getElementById('projTitle'),
        tab: document.getElementById('tabTitle'),
        stat: document.getElementById('stat'),
        mod: document.getElementById('modal'),
        inp: document.getElementById('fname')
    };

    // SYNC LAYOUT
    function syncLayout() {
        const val = dom.ed.value;
        const lines = val.split('\n');
        const realWidth = dom.ed.clientWidth; 
        
        const cs = getComputedStyle(dom.ed);
        dom.gh.style.width = realWidth + 'px';
        dom.gh.style.padding = cs.padding;
        dom.gh.style.border = cs.border;
        dom.gh.style.boxSizing = cs.boxSizing;
        dom.gh.style.font = cs.font;
        dom.gh.style.letterSpacing = cs.letterSpacing;
        
        dom.gh.innerHTML = '';
        let gutterHTML = '';

        lines.forEach((txt, idx) => {
            const d = document.createElement('div');
            d.textContent = txt + '\u200B';
            dom.gh.appendChild(d);
            const h = d.offsetHeight;
            gutterHTML += `<div class="line-box" style="height:${h}px">${idx + 1}</div>`;
        });
        dom.gut.innerHTML = gutterHTML;
    }

    dom.ed.addEventListener('input', syncLayout);
    dom.ed.addEventListener('scroll', () => { dom.gut.scrollTop = dom.ed.scrollTop; });
    window.addEventListener('resize', syncLayout);
    const resizeObserver = new ResizeObserver(() => { syncLayout(); });
    resizeObserver.observe(dom.ed);


    // LOGIC
    function clean() {
        dom.ed.value = ''; fileH = null; dom.tab.textContent = '---'; 
        dom.stat.textContent='–û—á–∏—â–µ–Ω–æ'; syncLayout();
    }

    async function chooseFolder() {
        try {
            const h = await window.showDirectoryPicker();
            folderH = h; isDir = true; clean();
            dom.tit.textContent = h.name.toUpperCase();
            render();
            dom.stat.textContent='–ü–∞–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞';
        } catch(e){}
    }

    async function chooseFiles() {
        try {
            const arr = await window.showOpenFilePicker({
                multiple:true, types:[{description:'Code',accept:{'text/plain':['.prsh','.prshx','.txt']}}]
            });
            clean();
            handlesCache = arr; isDir = false; folderH = null;
            dom.tit.textContent = "–í–´–ë–†–ê–ù–ù–´–ï –§–ê–ô–õ–´";
            render();
            dom.stat.textContent='–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ' + arr.length;
        } catch(e){}
    }

    async function render() {
        dom.list.innerHTML='';
        const arr = [];
        
        if(isDir && folderH) {
            for await (const [n,h] of folderH.entries()) {
                if(h.kind=='file' && n.toUpperCase().match(/\.(PRSH|PRSHX|TXT)$/)) arr.push(h);
            }
        } else if(!isDir) {
            arr.push(...handlesCache);
        }

        if(arr.length==0) return dom.list.innerHTML='<li style="padding:15px;color:#666;text-align:center">–ü—É—Å—Ç–æ</li>';

        arr.sort((a,b)=>a.name.localeCompare(b.name)).forEach(h => {
            const li = document.createElement('li');
            li.className='file-item';
            const ico = h.name.match(/\.PRSHX/i) ? 'üß©':'üìÑ';
            li.innerHTML = `<span>${ico} ${h.name}</span> <span class="del-btn">‚úï</span>`;
            
            li.onclick = (e) => {
                if(e.target.className=='del-btn') return;
                loadFile(h);
                document.querySelectorAll('.file-item').forEach(x=>x.classList.remove('active'));
                li.classList.add('active');
            }
            li.querySelector('.del-btn').onclick = async () => {
                if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
                if(isDir) await folderH.removeEntry(h.name);
                else handlesCache = handlesCache.filter(x=>x!==h);
                if(fileH && fileH.name==h.name) clean();
                render();
            };
            dom.list.appendChild(li);
        });
    }

    async function loadFile(h) {
        try {
            fileH = h;
            const f = await h.getFile();
            dom.ed.value = await f.text();
            dom.tab.textContent = h.name;
            dom.stat.textContent = '–§–∞–π–ª: '+h.name;
            syncLayout(); 
        } catch(e){alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è')}
    }

    async function saveDoc() {
        if(!fileH) return alert('–ù–µ—Ç —Ñ–∞–π–ª–∞');
        try {
            const w = await fileH.createWritable();
            await w.write(dom.ed.value);
            await w.close();
            dom.stat.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            setTimeout(()=>dom.stat.textContent='...', 2000);
        } catch(e){alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')}
    }

    function newFileAsk() {
        if(!isDir) return alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É —Å–Ω–∞—á–∞–ª–∞');
        dom.mod.style.display='flex';
        dom.inp.value=''; dom.inp.focus();
    }
    
    async function createYes() {
        let n = dom.inp.value.trim();
        if(!n) return;
        if(!n.toUpperCase().match(/\.(PRSH|PRSHX)$/)) n+='.PRSH';
        try {
            const nh = await folderH.getFileHandle(n, {create:true});
            const w = await nh.createWritable();
            await w.write(`–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {\n    \n}`); 
            await w.close();
            dom.mod.style.display='none';
            await render();
            loadFile(nh);
        } catch(e){alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è')}
    }

    document.addEventListener('keydown', e=>{
        if(e.ctrlKey && e.key=='s'){e.preventDefault();saveDoc();}
    });
</script>
</body>
</html>
