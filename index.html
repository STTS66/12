<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode Editor v1.5</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --gutter-text: #858585;
            --text-color: #cccccc;
            --accent-color: #007acc;
            --header-height: 45px;
            --font-family: 'Consolas', 'Courier New', monospace;
            --font-size: 14px;
            --line-height: 20px;
        }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        header {
            height: var(--header-height); background-color: #333;
            display: flex; align-items: center; padding: 0 15px;
            justify-content: space-between; user-select: none;
            border-bottom: 1px solid #111;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .controls { display: flex; align-items: center; gap: 10px; }
        
        .btn {
            border: none; color: white; padding: 6px 14px;
            border-radius: 3px; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; gap: 5px;
            transition: 0.2s;
        }
        
        /* –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        .btn-primary { background-color: var(--accent-color); font-weight: bold;}
        .btn-primary:hover { background-color: #005fa3; }

        /* –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è */
        .btn-secondary { background-color: #4d4d4d; }
        .btn-secondary:hover { background-color: #666; }
        
        /* –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å" (–ó–µ–ª–µ–Ω–∞—è –¥–ª—è –∑–∞–º–µ—Ç–Ω–æ—Å—Ç–∏) */
        .btn-success { background-color: #2da042; }
        .btn-success:hover { background-color: #238535; }

        .workspace {
            display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px);
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background-color: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        
        .sidebar-header {
            padding: 10px; font-size: 11px; font-weight: bold; color: #888;
            text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between;
        }

        .file-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex:1;}
        .file-item { 
            padding: 5px 10px; cursor: pointer; display: flex; 
            justify-content: space-between; color:#bbb; align-items:center; 
            font-size:13px; border-left: 3px solid transparent;
        }
        .file-item:hover { background: #2a2d2e; color: #fff;}
        .file-item.active { background: #37373d; border-left-color: var(--accent-color); color: white;}

        /* EDITOR AREA */
        .editor-container {
            flex: 1; display: flex; flex-direction: column;
            background: var(--bg-color); position: relative;
        }

        .tab-bar { 
            height: 30px; background: #252526; display: flex; align-items: center; 
            border-bottom: 1px solid #111;
        }
        .tab { 
            padding: 0 15px; height: 100%; display: flex; align-items: center; 
            background: #1e1e1e; color: #fff; font-size: 12px; 
            border-top: 2px solid var(--accent-color);
            border-right: 1px solid #252526;
        }

        .code-area { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* GUTTER (–Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫) */
        .gutter {
            width: 45px; background: #1e1e1e; color: #6e7681;
            text-align: right; border-right: 1px solid #333; user-select: none;
            padding-top: 10px; box-sizing: border-box; overflow: hidden;
        }
        .line-number {
            font-size: var(--font-size); font-family: var(--font-family);
            line-height: var(--line-height); padding-right: 10px; box-sizing: border-box;
        }

        /* TEXTAREA */
        textarea#editor {
            flex: 1; background: transparent; color: #d4d4d4; border: none;
            resize: none; padding: 10px;
            font-family: var(--font-family); font-size: var(--font-size);
            line-height: var(--line-height);
            outline: none; white-space: pre-wrap; overflow-y: scroll;
            overflow-x: hidden; box-sizing: border-box; z-index: 2;
        }

        /* Hidden Helper */
        #size-calculator {
            visibility: hidden; position: absolute; top: -9999px; left: -9999px;
            width: calc(100% - 55px); padding: 10px; box-sizing: border-box;
            font-family: var(--font-family); font-size: var(--font-size);
            line-height: var(--line-height); white-space: pre-wrap; word-wrap: break-word;
        }

        footer { 
            height: 25px; background: var(--accent-color); 
            display: flex; align-items: center; padding: 0 15px; color: white; font-size: 11px; 
        }

        /* UTILS */
        .delete-btn { opacity: 0; font-weight: bold; margin-left: 10px; transition: 0.2s;}
        .file-item:hover .delete-btn { opacity: 1; color: #aaa; }
        .delete-btn:hover { color: #f55; }

        .modal-overlay { 
            display: none; position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:99;
        }
        .modal { background:#252526; padding:20px; border-radius:5px; text-align:center; box-shadow:0 5px 20px rgba(0,0,0,0.5); width: 300px; border: 1px solid #444;}
        .modal input { 
            background: #3c3c3c; color: white; border:1px solid #555; 
            padding:8px; width:90%; margin-bottom: 15px; margin-top: 5px; outline: none;
        }
        .modal h3 { margin-top: 0; color: #ccc;}
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; color: white; margin-right: 10px;">Roode <span style="opacity:0.5; font-size: 11px;">1.5</span></div>
    
    <div class="controls">
        <!-- –ì–õ–ê–í–ù–ê–Ø –ö–ù–û–ü–ö–ê -->
        <button class="btn btn-primary" onclick="openFolderHandle()" title="–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É —Å –ø—Ä–æ–µ–∫—Ç–æ–º">
            üìÇ –û–¢–ö–†–´–¢–¨ –ü–ê–ü–ö–£
        </button>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ -->
        <button class="btn btn-success" onclick="tryCreateFile()">
            ‚ûï –°–æ–∑–¥–∞—Ç—å
        </button>

        <button class="btn btn-secondary" onclick="saveFileHandle()">
            üíæ
        </button>

        <div style="width: 1px; height: 20px; background: #555; margin: 0 5px;"></div>

        <!-- –ö–Ω–æ–ø–∫–∞ "–æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã" —Å–¥–µ–ª–∞–Ω–∞ –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å -->
        <button class="btn btn-secondary" style="font-size:11px; padding: 4px 8px;" onclick="openFilesHandle()" title="–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤">
            üìÑ –ø—Ä–æ—Å—Ç–æ —Ñ–∞–π–ª—ã
        </button>
    </div>
</header>

<div class="workspace">
    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span>–§–ê–ô–õ–´</span>
            <span onclick="refreshFileList()" style="cursor:pointer;" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</span>
        </div>
        <ul id="fileList" class="file-list">
            <li style="padding:20px 10px; text-align:center; color:#555; font-size:12px; line-height: 1.5;">
                –ü–∞–ø–∫–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞.<br>–ù–∞–∂–º–∏—Ç–µ <b>üìÇ –û–¢–ö–†–´–¢–¨ –ü–ê–ü–ö–£</b> —Å–≤–µ—Ä—Ö—É.
            </li>
        </ul>
    </div>

    <!-- –†–ï–î–ê–ö–¢–û–† -->
    <div class="editor-container">
        <div class="tab-bar">
            <div class="tab" id="currentFileName">–ù–µ—Ç —Ñ–∞–π–ª–∞</div>
        </div>
        
        <div class="code-area">
            <div id="gutter" class="gutter"><div class="line-number">1</div></div>
            <textarea id="editor" spellcheck="false" placeholder="–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à –∫–æ–¥..."></textarea>
            <div id="size-calculator"></div>
        </div>
    </div>
</div>

<footer>
    <div id="statusbar">–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>
</footer>

<!-- –ú–û–î–ê–õ–ö–ê –°–û–ó–î–ê–ù–ò–Ø -->
<div class="modal-overlay" id="createModal">
    <div class="modal">
        <h3>–ù–æ–≤—ã–π —Ñ–∞–π–ª</h3>
        <input type="text" id="newFilenameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä script.PRSH)">
        <div>
            <button class="btn btn-success" onclick="finalizeCreation()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="document.getElementById('createModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
    // == GLOBAL STATE ==
    let folderHandle = null;  // –û–±—ä–µ–∫—Ç –ø–∞–ø–∫–∏
    let activeFileHandle = null; // –û–±—ä–µ–∫—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
    let isFolderMode = false;

    // == ELEMENTS ==
    const els = {
        editor: document.getElementById('editor'),
        gutter: document.getElementById('gutter'),
        calc: document.getElementById('size-calculator'),
        list: document.getElementById('fileList'),
        tabName: document.getElementById('currentFileName'),
        status: document.getElementById('statusbar'),
        modal: document.getElementById('createModal'),
        filenameInput: document.getElementById('newFilenameInput')
    };

    // 1. –û–¢–ö–†–´–¢–ò–ï –ü–ê–ü–ö–ò (–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
    async function openFolderHandle() {
        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø–∞–ø–∫–µ
            folderHandle = await window.showDirectoryPicker();
            isFolderMode = true;
            els.status.textContent = `–ü–∞–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞: ${folderHandle.name}`;
            await refreshFileList();
        } catch(e) {
            console.log(e); // –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞"
        }
    }

    // 2. –û–¢–ö–†–´–¢–ò–ï –§–ê–ô–õ–û–í (–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è)
    async function openFilesHandle() {
        try {
            const handles = await window.showOpenFilePicker({
                multiple: true,
                types: [{description: 'Code', accept: {'text/plain': ['.PRSH','.PRSHX','.txt']}}]
            });
            isFolderMode = false;
            folderHandle = null;
            els.status.textContent = "–†–µ–∂–∏–º –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤";
            renderFilesList(handles);
        } catch(e) {}
    }

    // 3. –ü–û–°–¢–†–û–ï–ù–ò–ï –°–ü–ò–°–ö–ê –§–ê–ô–õ–û–í
    async function refreshFileList() {
        if (!folderHandle) return;
        
        const files = [];
        // –ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –≤—Å–µ–π –ø–∞–ø–∫–µ
        for await (const [name, handle] of folderHandle.entries()) {
            if (handle.kind === 'file') {
                const upper = name.toUpperCase();
                // –§–∏–ª—å—Ç—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
                if(upper.endsWith('.PRSH') || upper.endsWith('.PRSHX') || upper.endsWith('.TXT')) {
                    files.push(handle);
                }
            }
        }
        renderFilesList(files);
    }

    function renderFilesList(handles) {
        els.list.innerHTML = '';
        if(handles.length === 0) {
            els.list.innerHTML = '<li style="padding:15px;text-align:center;color:#666;">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ—Ç .PRSH —Ñ–∞–π–ª–æ–≤</li>';
            return;
        }

        handles.forEach(h => {
            const li = document.createElement('li');
            li.className = 'file-item';
            if(activeFileHandle && activeFileHandle.name === h.name) li.classList.add('active');
            
            // –ò–∫–æ–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            let icon = 'üìÑ';
            if(h.name.toUpperCase().endsWith('.PRSHX')) icon = 'üß©';

            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span style="margin-right:8px; opacity:0.7">${icon}</span> ${h.name}
                </div>
                <div class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å">üóë</div>
            `;

            // –ö–ª–∏–∫ –ø–æ —Ñ–∞–π–ª—É - –æ—Ç–∫—Ä—ã—Ç—å
            li.onclick = (e) => {
                if(!e.target.classList.contains('delete-btn')) loadFile(h);
            };

            // –ö–ª–∏–∫ –ø–æ —É–¥–∞–ª–µ–Ω–∏—é
            li.querySelector('.delete-btn').onclick = async (e) => {
                e.stopPropagation();
                if(confirm(`–£–¥–∞–ª–∏—Ç—å ${h.name} –Ω–∞–≤—Å–µ–≥–¥–∞?`)) {
                    if(isFolderMode && folderHandle) {
                        try {
                            await folderHandle.removeEntry(h.name);
                            if(activeFileHandle && activeFileHandle.name === h.name) clearEditor();
                            refreshFileList();
                        } catch(err) { alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è. –ù–µ—Ç –ø—Ä–∞–≤?"); }
                    } else {
                        // –í —Ä–µ–∂–∏–º–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∏–∑ view
                        li.remove();
                    }
                }
            };

            els.list.appendChild(li);
        });
    }

    // 4. –ó–ê–ì–†–£–ó–ö–ê –°–û–î–ï–†–ñ–ò–ú–û–ì–û
    async function loadFile(handle) {
        try {
            const file = await handle.getFile();
            const text = await file.text();
            els.editor.value = text;
            activeFileHandle = handle;
            els.tabName.textContent = handle.name;
            els.status.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: " + handle.name;
            updateLineNumbers();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            Array.from(els.list.children).forEach(li => li.classList.remove('active'));
            refreshFileList(); // –ì—Ä—É–±—ã–π, –Ω–æ –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—å active –∫–ª–∞—Å—Å
        } catch(e) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª");
        }
    }

    function clearEditor() {
        els.editor.value = '';
        activeFileHandle = null;
        els.tabName.textContent = "–ù–µ—Ç —Ñ–∞–π–ª–∞";
        updateLineNumbers();
    }

    // 5. –°–û–•–†–ê–ù–ï–ù–ò–ï
    async function saveFileHandle() {
        if (!activeFileHandle) return alert("–ù–µ –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
        
        try {
            const writable = await activeFileHandle.createWritable();
            await writable.write(els.editor.value);
            await writable.close();
            els.status.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: " + new Date().toLocaleTimeString();
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
            const btn = document.querySelector('.btn-secondary'); 
            const prev = btn.textContent;
            btn.textContent = "‚úÖ";
            setTimeout(() => btn.textContent = prev, 1000);
            
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
        }
    }

    // 6. –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ì–û –§–ê–ô–õ–ê
    function tryCreateFile() {
        if(!isFolderMode || !folderHandle) {
            if(confirm("–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä—ã—Ç—å –ü–ê–ü–ö–£. –û—Ç–∫—Ä—ã—Ç—å –µ—ë —Å–µ–π—á–∞—Å?")) {
                openFolderHandle();
            }
            return;
        }
        els.modal.style.display = 'flex';
        els.filenameInput.focus();
    }

    async function finalizeCreation() {
        let name = els.filenameInput.value.trim();
        if(!name) return;
        
        // –ê–≤—Ç–æ-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
        if(!name.toUpperCase().match(/\.(PRSH|PRSHX)$/)) name += '.PRSH';
        
        const tmpl = `–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {
    // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...
}`;

        try {
            // –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –≤ —Ç–µ–∫—É—â–µ–π –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–∞–ø–∫–µ
            const newHandle = await folderHandle.getFileHandle(name, {create: true});
            const writable = await newHandle.createWritable();
            await writable.write(tmpl);
            await writable.close();

            els.modal.style.display = 'none';
            els.filenameInput.value = '';
            
            await refreshFileList();
            await loadFile(newHandle); // –°—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
            
        } catch(e) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å: " + e.message);
        }
    }

    // == –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ß–ê–°–¢–¨: –õ–û–ì–ò–ö–ê –°–¢–†–û–ö –ò –ü–ï–†–ï–ù–û–°–û–í (V1.3 FIX) ==
    function updateLineNumbers() {
        const text = els.editor.value;
        const lines = text.split('\n');
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —à–∏—Ä–∏–Ω—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
        els.calc.style.width = els.editor.clientWidth + 'px';
        els.calc.innerHTML = '';
        
        let html = '';
        lines.forEach((l, i) => {
            const div = document.createElement('div');
            div.textContent = l || ' '; // –ü—Ä–æ–±–µ–ª –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è, —á—Ç–æ–±—ã –±—ã–ª–∞ –≤—ã—Å–æ—Ç–∞
            els.calc.appendChild(div);
            
            // –ó–∞–±–∏—Ä–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫–∏ —Å —É—á–µ—Ç–æ–º –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
            const h = div.offsetHeight;
            html += `<div class="line-number" style="height:${h}px">${i+1}</div>`;
        });
        
        els.gutter.innerHTML = html;
    }

    els.editor.addEventListener('input', updateLineNumbers);
    els.editor.addEventListener('scroll', () => els.gutter.scrollTop = els.editor.scrollTop);
    window.addEventListener('resize', updateLineNumbers);

    // Initial message
    els.editor.value = "// –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 'üìÇ –û–¢–ö–†–´–¢–¨ –ü–ê–ü–ö–£' —Å–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É\n// –ó–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ñ–∞–π–ª—ã";
    setTimeout(updateLineNumbers, 50);

    // Hotkeys
    document.addEventListener('keydown', e => {
        if(e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveFileHandle();
        }
    });

</script>

</body>
</html>
