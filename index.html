<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode v2.1 (Multi-Save)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --line-number-color: #858585;
            --header-height: 40px;
            
            --editor-font: 'Consolas', 'Monaco', 'Courier New', monospace;
            --editor-size: 14px;
            --editor-line-height: 20px; 
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color); color: var(--text-color);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; font-family: -apple-system, sans-serif;
        }

        /* HEADER */
        header {
            height: var(--header-height); background: #333;
            display: flex; align-items: center; padding: 0 10px;
            justify-content: space-between; border-bottom: 1px solid #111; user-select: none;
        }
        .controls { display: flex; gap: 6px; }
        .logo { font-weight: bold; color: white; margin-right: 10px; font-size: 14px;}
        .btn {
            border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; color: white; 
            font-size: 11px; display: flex; align-items: center; transition: 0.2s; white-space: nowrap;
        }
        .btn-blue { background: var(--accent-color); } .btn-blue:hover{background:#0062a3;}
        .btn-green { background: #238636; } .btn-green:hover{background:#2ea043;}
        .btn-gray { background: #444; } .btn-gray:hover{background:#555;}

        /* MAIN */
        .workspace { display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px); }

        .sidebar {
            width: 250px; background: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 10px 15px; font-size: 11px; font-weight: bold; color: #aaa;
            text-transform: uppercase; background: #2b2b2c; display: flex; justify-content: space-between;
        }
        .file-list { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .file-item {
            padding: 4px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: #ccc; cursor: pointer; border-left: 3px solid transparent;
        }
        .file-item:hover { background: #2a2d2e; }
        .file-item.active { background: #37373d; border-left-color: var(--accent-color); color: #fff; }
        
        .del-btn { opacity: 0; color: #666; font-weight: bold; margin-left: 5px; }
        .file-item:hover .del-btn { opacity: 1; } .del-btn:hover { color: #f44; }

        .editor-container {
            flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-color); min-width: 0;
        }
        .tab-bar { height: 35px; background: #252526; display: flex; align-items: center; }
        .tab { 
            padding: 0 15px; height: 100%; display: flex; align-items: center;
            background: #1e1e1e; font-size: 13px; border-top: 2px solid var(--accent-color);
        }

        /* EDITOR */
        .code-wrapper {
            flex: 1; display: flex; position: relative; overflow: hidden; 
        }

        .gutter {
            width: 45px; flex-shrink: 0;
            background: #1e1e1e; color: var(--line-number-color);
            text-align: right; border-right: 1px solid #333;
            user-select: none; 
            overflow: hidden; 
            padding-top: 10px;
            box-sizing: border-box;
        }
        .line-num {
            height: var(--editor-line-height);
            line-height: var(--editor-line-height);
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            padding-right: 8px;
        }

        textarea#editor {
            flex: 1;
            background: transparent; border: none; outline: none; resize: none;
            color: var(--text-color);
            padding: 10px;
            box-sizing: border-box;
            
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
            tab-size: 4;

            /* NO WRAP (–ö–ê–ö –¢–´ –ü–†–û–°–ò–õ –í 2.0) */
            white-space: pre;   
            overflow-x: scroll; 
            overflow-y: scroll; 
        }

        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }
        ::-webkit-scrollbar-corner { background: #1e1e1e; }

        footer { height: 25px; background: var(--accent-color); display: flex; align-items: center; padding: 0 15px; color: white; font-size: 11px; }

        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:99;}
        .modal { background: #252526; padding: 20px; width: 300px; border:1px solid #444; text-align:center;}
        .modal input { width: 90%; padding: 5px; margin: 10px 0; background: #3c3c3c; border: 1px solid #555; color: #fff;}
    </style>
</head>
<body>

<header>
    <div class="logo">Roode <span style="font-size:10px;opacity:0.5">2.1 Multi-Save</span></div>
    <div class="controls">
        <button class="btn btn-blue" onclick="selFolder()">üìÇ –ü–∞–ø–∫–∞</button>
        <button class="btn btn-green" onclick="showNew()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn btn-gray" onclick="save()">üíæ SAVE ALL</button>
        <div style="width:1px; background:#444; height:18px;"></div>
        <button class="btn btn-gray" onclick="selFiles()">üìÑ –û—Ç–¥. –§–∞–π–ª—ã</button>
    </div>
</header>

<div class="workspace">
    <div class="sidebar">
        <div class="sidebar-header">
            <span id="labelHeader">–ü–†–û–í–û–î–ù–ò–ö</span>
            <span style="cursor:pointer" onclick="listRender()">‚Üª</span>
        </div>
        <ul id="listUI" class="file-list"></ul>
    </div>
    <div class="editor-container">
        <div class="tab-bar"><div class="tab" id="tabInfo">...</div></div>
        
        <div class="code-wrapper">
            <div id="gutter" class="gutter"></div>
            <textarea id="editor" spellcheck="false" placeholder="// 1. –û—Ç–∫—Ä–æ–π –ø–∞–ø–∫—É –ò–õ–ò –∑–∞–≥—Ä—É–∑–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã..."></textarea>
        </div>
    </div>
</div>

<footer><div id="msg">–ì–æ—Ç–æ–≤</div></footer>

<div class="overlay" id="mod"><div class="modal">
    <h3>–ù–æ–≤—ã–π —Ñ–∞–π–ª</h3><input id="fname"><br>
    <button class="btn btn-blue" onclick="createFile()">OK</button>
    <button class="btn btn-gray" onclick="document.getElementById('mod').style.display='none'">X</button>
</div></div>

<script>
    // VARS
    let fHandle = null; 
    let fileH = null;   // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∞–π–ª
    let isDir = false; 
    let filesCache = []; // –•—Ä–∞–Ω–∏—Ç handles –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

    // –≠–¢–û –ë–ê–ó–ê: –ó–¥–µ—Å—å —Ö—Ä–∞–Ω–∏–º —Ç–µ–∫—Å—Ç —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–∂–∏–º–µ "–û—Ç–¥. –§–∞–π–ª—ã"
    // { "file1.prsh": "–∫–æ–¥...", "file2.prsh": "–∫–æ–¥..." }
    let projectMemory = {}; 

    const ed = document.getElementById('editor');
    const gut = document.getElementById('gutter');
    const ui = document.getElementById('listUI');
    const msg = document.getElementById('msg');
    const tab = document.getElementById('tabInfo');
    const label = document.getElementById('labelHeader');

    // -- NUMBERS --
    function updateLines() {
        const linesCount = ed.value.split('\n').length;
        let html = '';
        for(let i=0; i < linesCount; i++){
            html += `<div class="line-num">${i+1}</div>`;
        }
        gut.innerHTML = html;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç—å –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
    ed.addEventListener('input', () => {
        updateLines();
        // –ï—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ "–û—Ç–¥. –§–∞–π–ª—ã" –∏ —Ñ–∞–π–ª –æ—Ç–∫—Ä—ã—Ç - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –û–ó–£
        if(!isDir && fileH) {
            projectMemory[fileH.name] = ed.value;
        }
    });

    ed.addEventListener('scroll', () => { gut.scrollTop = ed.scrollTop; });
    ed.addEventListener('keydown', ()=> setTimeout(updateLines,0));

    // -- LOADERS --
    
    // 1. –ü–∞–ø–∫–∞ (–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º)
    async function selFolder() {
        try {
            fHandle = await window.showDirectoryPicker();
            isDir = true; label.textContent = fHandle.name.toUpperCase();
            
            // –°–±—Ä–æ—Å
            projectMemory = {};
            filesCache = [];
            
            resetEd();
            listRender();
        } catch(e){}
    }

    // 2. –û—Ç–¥. –§–∞–π–ª—ã (–£–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º)
    async function selFiles() {
        try {
            filesCache = await window.showOpenFilePicker({
                multiple:true, 
                types:[{description:'Code',accept:{'text/plain':['.prsh','.prshx','.txt']}}]
            });
            isDir = false; 
            fHandle = null; 
            label.textContent = "–§–ê–ô–õ–´ –í –ü–ê–ú–Ø–¢–ò";
            
            resetEd();
            
            // –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –í–°–ï–ì–û –í –ü–ê–ú–Ø–¢–¨
            msg.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            projectMemory = {};
            
            for (let h of filesCache) {
                const f = await h.getFile();
                projectMemory[h.name] = await f.text();
            }
            
            msg.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${filesCache.length} —Ñ–∞–π–ª–æ–≤`;
            listRender();
            
        } catch(e){
            console.error(e);
        }
    }

    function resetEd() {
        fileH = null; ed.value = ''; tab.textContent = "---"; updateLines();
    }

    async function listRender() {
        ui.innerHTML = '';
        let list = [];
        if(isDir && fHandle) {
            for await (const [n, h] of fHandle.entries()) {
                if(h.kind==='file' && n.toUpperCase().match(/\.(PRSH|PRSHX|TXT)$/)) list.push(h);
            }
        } else if(!isDir) list = [...filesCache];

        list.sort((a,b)=>a.name.localeCompare(b.name)).forEach(h => {
            const li = document.createElement('li');
            li.className='file-item';
            if(fileH && fileH.name===h.name) li.classList.add('active');
            
            const ico = h.name.match(/X$/i)?'üß©':'üìÑ';
            li.innerHTML = `<span>${ico} ${h.name}</span><span class="del-btn">üóë</span>`;
            
            // CLICK to OPEN
            li.onclick = (e) => {
                if(e.target.className.includes('del')) return;
                load(h);
            };

            // CLICK to DELETE
            li.querySelector('.del-btn').onclick = async()=>{
                if(!confirm('–£–±—Ä–∞—Ç—å —Ñ–∞–π–ª?'))return;
                if(isDir) await fHandle.removeEntry(h.name);
                else {
                    filesCache = filesCache.filter(x=>x!=h);
                    delete projectMemory[h.name];
                }
                if(fileH && fileH.name == h.name) resetEd();
                listRender();
            };
            ui.appendChild(li);
        });
        if(list.length==0) ui.innerHTML = '<div style="padding:20px;text-align:center;color:#555">–ü—É—Å—Ç–æ</div>';
    }

    // –û–¢–ö–†–´–¢–ò–ï
    async function load(h) {
        fileH = h;
        
        // –í–∏–∑—É–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç
        const items = document.querySelectorAll('.file-item');
        items.forEach(i => i.classList.remove('active'));
        listRender(); // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è active (–≥—Ä—É–±–æ, –Ω–æ –Ω–∞–¥–µ–∂–Ω–æ)

        if(isDir) {
            // –ï—Å–ª–∏ –ø–∞–ø–∫–∞ - —á–∏—Ç–∞–µ–º —Å –¥–∏—Å–∫–∞
            const f = await h.getFile();
            ed.value = await f.text();
        } else {
            // –ï—Å–ª–∏ —Ñ–∞–π–ª—ã - —á–∏—Ç–∞–µ–º –∏–∑ –ü–ê–ú–Ø–¢–ò
            ed.value = projectMemory[h.name] || "";
        }
        
        tab.textContent = h.name;
        msg.textContent = h.name;
        updateLines();
    }

    // === –°–û–•–†–ê–ù–ï–ù–ò–ï ===
    async function save() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –†–µ–∂–∏–º –ø–∞–ø–∫–∏
        if(isDir) {
            if(!fileH) return alert('–§–∞–π–ª –Ω–µ –æ—Ç–∫—Ä—ã—Ç');
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¢–û–õ–¨–ö–û –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∞–π–ª
            const w = await fileH.createWritable();
            await w.write(ed.value);
            await w.close();
            notify(`–°–æ—Ö—Ä–∞–Ω–µ–Ω: ${fileH.name}`);
        } 
        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –†–µ–∂–∏–º —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ (Fix User Request)
        else {
            if(filesCache.length === 0) return alert("–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤");

            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–º—è—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ (—á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –±—ã–ª–æ —Å–≤–µ–∂–µ–µ)
            if(fileH) projectMemory[fileH.name] = ed.value;

            msg.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö...";
            
            try {
                // 2. –¶–∏–∫–ª –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º –≤ —Å–ø–∏—Å–∫–µ
                let count = 0;
                for(let h of filesCache) {
                    const content = projectMemory[h.name];
                    // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –µ—Å—Ç—å, –ø–∏—à–µ–º –Ω–∞ –¥–∏—Å–∫
                    if(content !== undefined) {
                        const w = await h.createWritable();
                        await w.write(content);
                        await w.close();
                        count++;
                    }
                }
                notify(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${count}`);
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
            }
        }
    }

    function notify(txt) {
        msg.textContent = txt;
        setTimeout(()=>msg.textContent='–ì–æ—Ç–æ–≤', 3000);
    }

    // NEW FILE (–¢–æ–ª—å–∫–æ –¥–ª—è –ø–∞–ø–æ–∫)
    function showNew(){ 
        if(!isDir) return alert('–°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –ü–∞–ø–∫–∏'); 
        document.getElementById('mod').style.display='block'; 
    }
    async function createFile(){
        let n = document.getElementById('fname').value;
        if(!n) return;
        if(!n.match(/\./)) n+='.PRSH';
        const nh = await fHandle.getFileHandle(n,{create:true});
        const w = await nh.createWritable(); await w.write('–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {\n\n}'); await w.close();
        document.getElementById('mod').style.display='none';
        listRender();
        load(nh);
    }

    document.addEventListener('keydown', e=>{if(e.ctrlKey&&e.key=='s'){e.preventDefault();save()}});
</script>
</body>
</html>
