<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode - Editor v1.4</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --gutter-text: #858585;
            --text-color: #cccccc;
            --accent-color: #007acc;
            --header-height: 40px;
            --font-family: 'Consolas', 'Courier New', monospace;
            --font-size: 14px;
            --line-height: 20px;
        }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        header {
            height: var(--header-height); background-color: #3c3c3c;
            display: flex; align-items: center; padding: 0 15px;
            justify-content: space-between; user-select: none;
        }

        .controls { display: flex; gap: 8px; }
        .controls button {
            background-color: var(--accent-color); border: none; color: white;
            padding: 5px 12px; border-radius: 3px; cursor: pointer;
            white-space: nowrap; font-size: 12px;
        }
        .controls button.secondary { background-color: #444; }
        .controls button:hover { opacity: 0.9; }

        .workspace {
            display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px);
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background-color: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        .file-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex:1;}
        .file-item { padding: 5px 10px; cursor: pointer; display: flex; justify-content: space-between; color:#bbb; align-items:center; font-size:13px;}
        .file-item:hover { background: #2a2d2e; color: #fff;}
        .file-item.active { background: #37373d; border-left: 3px solid var(--accent-color);}

        /* EDITOR */
        .editor-container {
            flex: 1; display: flex; flex-direction: column; position: relative;
            background: var(--bg-color);
        }

        .tab-bar { height: 35px; background: #2d2d2d; display: flex; align-items: center; }
        .tab { padding: 0 15px; height: 100%; display: flex; align-items: center; background: var(--bg-color); color: #fff; font-size: 13px; border-top: 1px solid var(--accent-color); }

        .code-area {
            flex: 1; display: flex; position: relative; overflow: hidden;
        }

        .gutter {
            width: 50px; background: var(--sidebar-color); color: var(--gutter-text);
            text-align: right; border-right: 1px solid #444; user-select: none;
            padding-top: 10px; box-sizing: border-box; overflow: hidden;
        }

        .line-number {
            font-size: var(--font-size); font-family: var(--font-family);
            line-height: var(--line-height); padding-right: 8px; box-sizing: border-box;
        }

        textarea#editor {
            flex: 1; background: transparent; color: #d4d4d4; border: none;
            resize: none; padding: 10px;
            font-family: var(--font-family); font-size: var(--font-size);
            line-height: var(--line-height);
            outline: none; white-space: pre-wrap; overflow-y: scroll;
            overflow-x: hidden; box-sizing: border-box; z-index: 2;
        }

        /* –¢–µ–Ω—å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –≤—ã—Å–æ—Ç—ã */
        #size-calculator {
            visibility: hidden; position: absolute; top: -9999px; left: -9999px;
            width: calc(100% - 60px); padding: 10px; box-sizing: border-box;
            font-family: var(--font-family); font-size: var(--font-size);
            line-height: var(--line-height); white-space: pre-wrap; word-wrap: break-word;
        }

        footer { height: 25px; background: var(--accent-color); display: flex; align-items: center; padding: 0 15px; color: white; font-size: 12px; }

        .delete-btn { opacity: 0; color: #888; font-weight: bold; font-size: 16px; padding: 0 5px;}
        .file-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #ff4d4d; }

        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:99;}
        .modal { background:#252526; padding:20px; border-radius:5px; text-align:center; box-shadow:0 0 10px #000; width: 300px;}
        .modal input { background: #333; color: white; border:1px solid #555; padding:8px; width:90%; margin-bottom: 10px;}
        .mode-label { font-size: 10px; color: #aaa; margin-left: auto; margin-right: 10px; text-transform: uppercase;}
    </style>
</head>
<body>

<header>
    <div style="color:white; font-weight:bold; display:flex; flex-direction:column; line-height:12px;">
        Roode <small style="font-size:9px;opacity:0.5; margin-top:2px;">v1.4 Multi-load</small>
    </div>
    
    <div class="controls">
        <button class="secondary" onclick="openFolderPicker()">üìÇ –ü–∞–ø–∫–∞</button>
        <button class="secondary" onclick="openFilesPicker()">üìÑ+ –û—Ç–∫—Ä. –§–∞–π–ª—ã</button>
        <button class="secondary" onclick="newFileUI()">‚ú® –°–æ–∑–¥–∞—Ç—å</button>
        <button onclick="saveFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</header>

<div class="workspace">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div style="padding:10px; color:#aaa; font-size:11px; font-weight:bold; display:flex; align-items:center;">
            –ü–†–û–í–û–î–ù–ò–ö 
            <span id="explorerMode" style="margin-left:auto; font-weight:normal; font-size:9px; border:1px solid #444; padding:1px 4px; border-radius:3px;">–ü–£–°–¢–û</span>
            <span onclick="refreshList()" style="cursor:pointer; margin-left:10px;" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</span>
        </div>
        <ul id="fileList" class="file-list"></ul>
    </div>

    <!-- EDITOR AREA -->
    <div class="editor-container">
        <div class="tab-bar">
            <div class="tab" id="currentFile">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</div>
            <div class="mode-label" id="savingStatus"></div>
        </div>
        
        <div class="code-area">
            <div id="gutter" class="gutter"><div class="line-number">1</div></div>
            <textarea id="editor" spellcheck="false" placeholder="–ö–æ–¥ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å..."></textarea>
            <div id="size-calculator"></div>
        </div>
    </div>
</div>

<footer>
    <div id="status">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞</div>
</footer>

<!-- UI MODAL -->
<div class="overlay" id="modalUI">
    <div class="modal">
        <h3>–ù–æ–≤—ã–π —Ñ–∞–π–ª</h3>
        <p style="font-size:12px; color:#aaa;">–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤–Ω—É—Ç—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–∞–ø–∫–∏</p>
        <input id="filename" placeholder="Name.PRSH">
        <button onclick="createFileExec()">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="secondary" onclick="document.getElementById('modalUI').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    let dirHandle = null;         // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–∞–ø–∫–∞
    let activeFiles = [];         // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
    let fileHandle = null;        // –¢–µ–∫—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ñ–∞–π–ª
    let mode = 'empty';           // 'folder' –∏–ª–∏ 'files'

    const editor = document.getElementById('editor');
    const gutter = document.getElementById('gutter');
    const shadow = document.getElementById('size-calculator');
    const fileListEl = document.getElementById('fileList');

    // === –õ–û–ì–ò–ö–ê –ù–£–ú–ï–†–ê–¶–ò–ò (–°–û–•–†–ê–ù–ï–ù–ê –° FIX 1.3) ===
    function updateLineNumbers() {
        const text = editor.value;
        const lines = text.split('\n');
        
        shadow.style.width = editor.clientWidth + 'px'; // –°–∏–Ω—Ö—Ä–æ–Ω —à–∏—Ä–∏–Ω—ã
        shadow.innerHTML = ''; 

        let htmlNumbers = '';
        lines.forEach((lineText, index) => {
            const div = document.createElement('div');
            div.textContent = lineText || ' '; 
            div.style.lineHeight = '20px';
            shadow.appendChild(div);
            
            const height = div.offsetHeight;
            htmlNumbers += `<div class="line-number" style="height:${height}px">${index + 1}</div>`;
        });
        gutter.innerHTML = htmlNumbers;
    }

    editor.addEventListener('input', updateLineNumbers);
    editor.addEventListener('scroll', () => { gutter.scrollTop = editor.scrollTop; });
    window.addEventListener('resize', updateLineNumbers);

    // –ù–∞—á–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω
    editor.value = `// –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã (.PRSH)
// –ú–µ–Ω—é —Å–≤–µ—Ä—Ö—É "üìÑ+ –û—Ç–∫—Ä. –§–∞–π–ª—ã"`;
    setTimeout(updateLineNumbers, 100);

    // === –§–£–ù–ö–¶–ò–û–ù–ê–õ –û–¢–ö–†–´–¢–ò–Ø ===

    // 1. –û—Ç–∫—Ä—ã—Ç—å –ü–ê–ü–ö–£
    async function openFolderPicker() {
        try {
            dirHandle = await window.showDirectoryPicker();
            mode = 'folder';
            activeFiles = []; // –°–±—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            fileHandle = null;
            document.getElementById('explorerMode').innerText = "–ü–ê–ü–ö–ê";
            document.getElementById('status').innerText = '–û—Ç–∫—Ä—ã—Ç–∞ –ø–∞–ø–∫–∞: ' + dirHandle.name;
            await refreshList();
        } catch(e) {
            console.log("–û—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏");
        }
    }

    // 2. –û—Ç–∫—Ä—ã—Ç—å –§–ê–ô–õ–´ (–ú—É–ª—å—Ç–∏–∑–∞–≥—Ä—É–∑–∫–∞)
    async function openFilesPicker() {
        try {
            // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–±–∏—Ä–∞—Ç—å .PRSH, .PRSHX –∏ .txt
            const handles = await window.showOpenFilePicker({
                multiple: true,
                types: [{
                    description: 'RuPL Files',
                    accept: {'text/plain': ['.PRSH', '.PRSHX', '.txt']}
                }]
            });
            
            mode = 'files';
            dirHandle = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–∞–ø–∫—É, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º —Ñ–∞–π–ª–æ–≤
            document.getElementById('explorerMode').innerText = "–°–ü–ò–°–û–ö";
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∫ —Ç–µ–∫—É—â–∏–º (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–≥—Ä—É–∂–∞—Ç—å)
            // –ò—Å–∫–ª—é—á–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∏–º–µ–Ω–∏
            for (let h of handles) {
                if(!activeFiles.find(f => f.name === h.name)) {
                    activeFiles.push(h);
                }
            }
            
            document.getElementById('status').innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${activeFiles.length}`;
            refreshList();
        } catch(e) {
            if(e.name !== 'AbortError') alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç–æ API.");
        }
    }

    // === –û–¢–†–ò–°–û–í–ö–ê –°–ü–ò–°–ö–ê ===
    async function refreshList() {
        fileListEl.innerHTML = '';
        
        if (mode === 'folder' && dirHandle) {
            // –ß—Ç–µ–Ω–∏–µ –∏–∑ –ø–∞–ø–∫–∏
            for await (const [key, val] of dirHandle.entries()) {
                if(val.kind === 'file' && (key.toUpperCase().endsWith('.PRSH') || key.toUpperCase().endsWith('.PRSHX') || key.endsWith('.txt'))) {
                    createFileItemElement(key, val); // val —ç—Ç–æ —Ö–µ–Ω–¥–ª
                }
            }
        } else if (mode === 'files' && activeFiles.length > 0) {
            // –ß—Ç–µ–Ω–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞
            activeFiles.forEach(handle => {
                createFileItemElement(handle.name, handle);
            });
        } else {
            fileListEl.innerHTML = '<li style="padding:15px;text-align:center;font-size:12px;color:#666">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</li>';
        }
    }

    function createFileItemElement(name, handle) {
        const li = document.createElement('li');
        li.className = 'file-item';
        if(fileHandle && fileHandle.name === name) li.classList.add('active');

        // –ò–∫–æ–Ω–∫–∞ –∏ –∏–º—è
        const nameSpan = document.createElement('span');
        const ext = name.split('.').pop().toLowerCase();
        let icon = "üìÑ";
        if(ext === 'prshx') icon = "üß©";
        
        nameSpan.innerHTML = `${icon} ${name}`;
        nameSpan.style.pointerEvents = "none"; // –ß—Ç–æ–±—ã –∫–ª–∏–∫ —à–µ–ª –Ω–∞ li
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è
        li.onclick = () => loadFileContent(handle);

        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
        const delBtn = document.createElement('span');
        delBtn.className = 'delete-btn';
        delBtn.innerHTML = "&times;"; // –ö—Ä–µ—Å—Ç–∏–∫
        
        // –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
        delBtn.onclick = async (e) => {
            e.stopPropagation(); // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ñ–∞–π–ª
            if(mode === 'folder') {
                if(confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª ' + name + ' —Å –¥–∏—Å–∫–∞?')) {
                    await dirHandle.removeEntry(name);
                    if(fileHandle && fileHandle.name === name) resetEditor();
                    refreshList();
                }
            } else {
                // –í —Ä–µ–∂–∏–º–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                activeFiles = activeFiles.filter(f => f.name !== name);
                if(fileHandle && fileHandle.name === name) resetEditor();
                refreshList();
            }
        };

        li.appendChild(nameSpan);
        li.appendChild(delBtn);
        fileListEl.appendChild(li);
    }

    // === –†–ê–ë–û–¢–ê –° –ö–û–î–û–ú ===
    async function loadFileContent(handle) {
        try {
            fileHandle = handle;
            const file = await handle.getFile();
            const content = await file.text();
            
            editor.value = content;
            document.getElementById('currentFile').innerText = handle.name;
            updateLineNumbers();
            
            // –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –º–µ–Ω—é
            const allItems = document.querySelectorAll('.file-item');
            allItems.forEach(i => i.classList.remove('active'));
            refreshList(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–±–Ω–æ–≤–∏—Ç—å –∫–ª–∞—Å—Å—ã
            
        } catch(e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –±—ã–ª –ø–µ—Ä–µ–º–µ—â–µ–Ω.");
        }
    }

    function resetEditor() {
        editor.value = '';
        fileHandle = null;
        document.getElementById('currentFile').innerText = '...';
        updateLineNumbers();
    }

    // === –°–û–•–†–ê–ù–ï–ù–ò–ï ===
    async function saveFile() {
        if(!fileHandle) return alert("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω!");
        
        const code = editor.value.trim();
        // –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
        if(!code.toLowerCase().startsWith('–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatgpt') && !code.startsWith('//')) {
           // –î–∞–¥–∏–º –ø–æ–±–ª–∞–∂–∫—É, –Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–º
           // (–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∂–µ—Å—Ç–∫–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å, –º–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å return)
        }

        try {
            document.getElementById('savingStatus').innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
            const writable = await fileHandle.createWritable();
            await writable.write(editor.value);
            await writable.close();
            document.getElementById('status').innerText = '–§–∞–π–ª ' + fileHandle.name + ' –æ–±–Ω–æ–≤–ª–µ–Ω';
            document.getElementById('savingStatus').innerText = "";
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
        }
    }

    // === –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ì–û ===
    function newFileUI() {
        if(mode !== 'folder') {
            alert("–°–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–∞–π–ª—ã –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –ü–∞–ø–∫–∏. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É.");
            return;
        }
        document.getElementById('modalUI').style.display = 'flex';
    }

    async function createFileExec() {
        let name = document.getElementById('filename').value;
        if(!name) return;
        if(!name.toLowerCase().match(/\.prshx?$/)) name += '.PRSH';

        try {
            const tmpl = `–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {
    // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...
}`;
            const newHandle = await dirHandle.getFileHandle(name, {create: true});
            const writable = await newHandle.createWritable();
            await writable.write(tmpl);
            await writable.close();
            
            document.getElementById('modalUI').style.display = 'none';
            await refreshList();
            loadFileContent(newHandle);
        } catch(e) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª");
        }
    }

    // –•–æ—Ç–∫–µ–∏
    document.addEventListener('keydown', e => {
        if(e.ctrlKey && e.key === 's') { 
            e.preventDefault(); 
            saveFile(); 
        }
    });

</script>
</body>
</html>
