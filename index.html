<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode Editor v1.9 (Perfect Sync)</title>
    <style>
        :root {
            /* === –ù–ê–°–¢–†–û–ô–ö–ò === */
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --line-number-color: #858585;
            --header-height: 45px;
            
            /* –®—Ä–∏—Ñ—Ç –∏ –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫ –û–ë–Ø–ó–ê–ù–´ —Å–æ–≤–ø–∞–¥–∞—Ç—å –≤–µ–∑–¥–µ */
            --editor-font: 'Consolas', 'Monaco', 'Courier New', monospace;
            --editor-size: 14px;
            --editor-line-height: 20px; 
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color); color: var(--text-color);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; font-family: -apple-system, sans-serif;
        }

        /* HEADER */
        header {
            height: var(--header-height); background: #333;
            display: flex; align-items: center; padding: 0 15px;
            justify-content: space-between; border-bottom: 1px solid #111; user-select: none;
        }

        .logo { font-weight: 700; color: #fff; letter-spacing: 0.5px; }
        .controls { display: flex; gap: 8px; }
        .btn {
            border: none; padding: 6px 12px; border-radius: 4px;
            cursor: pointer; color: white; font-size: 12px; transition: 0.2s;
        }
        .btn-blue { background: var(--accent-color); }
        .btn-blue:hover { background: #0062a3; }
        .btn-gray { background: #444; }
        .btn-gray:hover { background: #555; }

        .workspace { display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px); }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 12px 15px; font-size: 11px; font-weight: bold; color: #aaa;
            text-transform: uppercase; background: #2b2b2c; display: flex; justify-content: space-between;
        }
        .file-list { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .file-item {
            padding: 5px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: #ccc; cursor: pointer; border-left: 3px solid transparent;
        }
        .file-item:hover { background: #2a2d2e; color: #fff; }
        .file-item.active { background: #37373d; border-left-color: var(--accent-color); color: #fff; }
        .del-btn { opacity: 0; font-weight: bold; color: #777; padding: 0 5px;}
        .file-item:hover .del-btn { opacity: 1; }
        .del-btn:hover { color: #f44; }

        /* EDITOR WRAPPER */
        .editor-container {
            flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-color);
        }
        .tab-bar { height: 35px; background: #252526; display: flex; align-items: center; border-bottom: 1px solid #111; }
        .tab { 
            padding: 0 15px; height: 100%; display: flex; align-items: center;
            background: #1e1e1e; font-size: 13px; border-top: 2px solid var(--accent-color);
        }

        /* --- MAGIC SYNC AREA --- */
        .code-wrapper {
            flex: 1; display: flex; position: relative; overflow: hidden;
        }

        /* NUMBERS COLUMN */
        .gutter {
            width: 50px; flex-shrink: 0;
            background: #1e1e1e; color: var(--line-number-color);
            text-align: right; border-right: 1px solid #333;
            user-select: none; padding-top: 10px; /* —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å padding —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
            box-sizing: border-box; overflow: hidden;
        }

        .line-box {
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
            padding-right: 10px;
            /* –í—ã—Å–æ—Ç–∞ –∑–∞–¥–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º */
        }

        /* ACTUAL EDITOR */
        textarea#editor {
            flex: 1;
            background: transparent; border: none; outline: none; resize: none;
            color: var(--text-color);
            padding: 10px; /* –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ —É gutter padding-top */
            box-sizing: border-box;
            
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
            tab-size: 4;

            /* WRAPPING SETTINGS */
            white-space: pre-wrap;       /* –£–≤–∞–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã, –Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å */
            overflow-wrap: break-word;   /* –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ */
            
            overflow-y: scroll; 
        }

        /* INVISIBLE CLONE FOR CALCULATIONS */
        #ghost-calc {
            position: absolute; top: 0; left: 0; visibility: hidden; pointer-events: none; z-index: -99;
            background: red; 
            /* –°—Ç–∏–ª—å –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º 1-–≤-1 */
            padding: 10px; 
            box-sizing: border-box;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
        }

        footer { height: 25px; background: var(--accent-color); display: flex; align-items: center; padding: 0 15px; color: white; font-size: 11px; }

        /* MODAL */
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:999;}
        .modal { background: #252526; padding: 25px; width: 300px; border-radius: 5px; box-shadow: 0 10px 30px #000; border:1px solid #444; text-align:center;}
        .modal input { width: 100%; padding: 8px; margin: 15px 0; background: #3c3c3c; border: 1px solid #555; color: #fff; box-sizing: border-box; outline:none;}
    </style>
</head>
<body>

<header>
    <div class="logo">Roode <span style="font-weight:normal;opacity:0.5">v1.9</span></div>
    <div class="controls">
        <button class="btn btn-blue" onclick="chooseFolder()">üìÇ –ü–ê–ü–ö–ê</button>
        <button class="btn btn-gray" onclick="newFileAsk()">‚ûï –°–û–ó–î–ê–¢–¨</button>
        <button class="btn btn-gray" onclick="saveDoc()">üíæ</button>
        <button class="btn btn-gray" style="padding:6px 8px;" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã" onclick="chooseFiles()">...</button>
    </div>
</header>

<div class="workspace">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span id="projTitle">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</span>
            <span style="cursor:pointer" onclick="render()">‚Üª</span>
        </div>
        <ul id="tree" class="file-list">
            <li style="padding:15px; text-align:center; color:#555;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>
        </ul>
    </div>

    <!-- EDITOR -->
    <div class="editor-container">
        <div class="tab-bar">
            <div class="tab" id="tabTitle">–ü—É—Å—Ç–æ</div>
        </div>
        
        <div class="code-wrapper">
            <!-- –°–¢–û–õ–ë–ò–ö –¶–ò–§–† -->
            <div id="gutter" class="gutter"></div>
            
            <!-- –†–ï–î–ê–ö–¢–û–† -->
            <textarea id="editor" spellcheck="false" placeholder="// –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É..."></textarea>
            
            <!-- –ü–†–ò–ó–†–ê–ö (–°—á–∏—Ç–∞–µ—Ç –≤—ã—Å–æ—Ç—É) -->
            <div id="ghost-calc"></div>
        </div>
    </div>
</div>

<footer>
    <div id="stat">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
</footer>

<div class="overlay" id="modal">
    <div class="modal">
        <h3 style="color:#ddd; margin:0">–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª</h3>
        <input id="fname" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ.PRSH" onkeydown="if(event.key==='Enter') createYes()">
        <button class="btn btn-blue" onclick="createYes()">OK</button>
        <button class="btn btn-gray" onclick="document.getElementById('modal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    // VARS
    let folderH = null;
    let fileH = null;
    let isDir = false;
    let handlesCache = [];

    // DOM ELEMENTS
    const dom = {
        ed: document.getElementById('editor'),
        gut: document.getElementById('gutter'),
        gh: document.getElementById('ghost-calc'),
        list: document.getElementById('tree'),
        tit: document.getElementById('projTitle'),
        tab: document.getElementById('tabTitle'),
        stat: document.getElementById('stat'),
        mod: document.getElementById('modal'),
        inp: document.getElementById('fname')
    };

    // --- MEGA SYNC FUNCTION ---
    // –≠—Ç–æ —Å–µ—Ä–¥—Ü–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function syncLayout() {
        const val = dom.ed.value;
        const lines = val.split('\n');

        // 1. –ë–µ—Ä–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –ø–æ–ª—è –≤–≤–æ–¥–∞ (–ò–°–ö–õ–Æ–ß–ê–Ø –°–∫—Ä–æ–ª–ª–±–∞—Ä!)
        // clientWidth = —à–∏—Ä–∏–Ω–∞ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ + padding. 
        const realWidth = dom.ed.clientWidth; 
        
        // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–∑—Ä–∞–∫–∞
        // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ CSS —Å–≤–æ–π—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞
        const cs = getComputedStyle(dom.ed);
        dom.gh.style.width = realWidth + 'px';
        dom.gh.style.padding = cs.padding;
        dom.gh.style.border = cs.border;
        dom.gh.style.boxSizing = cs.boxSizing; // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ
        dom.gh.style.font = cs.font;
        dom.gh.style.letterSpacing = cs.letterSpacing;
        
        // 3. –°—Ç—Ä–æ–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        dom.gh.innerHTML = '';
        let gutterHTML = '';

        lines.forEach((txt, idx) => {
            // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Ç–µ–∫—Å—Ç–∞ –≤ –ø—Ä–∏–∑—Ä–∞–∫–µ
            const d = document.createElement('div');
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è, –¥–æ–±–∞–≤–ª—è–µ–º Zero-Width Space, —á—Ç–æ–±—ã –æ–Ω–∞ –∏–º–µ–ª–∞ –≤—ã—Å–æ—Ç—É —à—Ä–∏—Ñ—Ç–∞
            d.textContent = txt + '\u200B';
            dom.gh.appendChild(d);
            
            // –°—Ä–∞–∑—É –∂–µ –º–µ—Ä—è–µ–º –µ–≥–æ –≤—ã—Å–æ—Ç—É
            const h = d.offsetHeight;

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ —Å —ç—Ç–æ–π –∂–µ –≤—ã—Å–æ—Ç–æ–π
            gutterHTML += `<div class="line-box" style="height:${h}px">${idx + 1}</div>`;
        });

        // 4. –†–µ–Ω–¥–µ—Ä–∏–º –Ω–æ–º–µ—Ä–∞
        dom.gut.innerHTML = gutterHTML;
    }

    // HANDLERS
    dom.ed.addEventListener('input', syncLayout);
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞: –ö—Ä—É—Ç–∏—à—å —Ç–µ–∫—Å—Ç -> –∫—Ä—É—Ç—è—Ç—Å—è —Ü–∏—Ñ—Ä—ã
    dom.ed.addEventListener('scroll', () => {
        dom.gut.scrollTop = dom.ed.scrollTop;
    });

    // –ü—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –æ–∫–Ω–∞ —à–∏—Ä–∏–Ω–∞ –º–µ–Ω—è–µ—Ç—Å—è, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã
    window.addEventListener('resize', syncLayout);
    
    // Observer –æ—Ç–ª–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–∂–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞
    const resizeObserver = new ResizeObserver(() => {
        syncLayout();
    });
    resizeObserver.observe(dom.ed);


    // --- FILESYSTEM ---
    function clean() {
        dom.ed.value = ''; fileH = null; dom.tab.textContent = '---'; 
        dom.stat.textContent='–û—á–∏—â–µ–Ω–æ'; syncLayout();
    }

    async function chooseFolder() {
        try {
            const h = await window.showDirectoryPicker();
            folderH = h; isDir = true; clean();
            dom.tit.textContent = h.name.toUpperCase();
            render();
            dom.stat.textContent='–ü–∞–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞';
        } catch(e){}
    }

    async function chooseFiles() {
        try {
            const arr = await window.showOpenFilePicker({
                multiple:true, types:[{description:'Code',accept:{'text/plain':['.prsh','.prshx','.txt']}}]
            });
            clean();
            handlesCache = arr; isDir = false; folderH = null;
            dom.tit.textContent = "–§–ê–ô–õ–´";
            render();
            dom.stat.textContent='–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ñ–∞–π–ª—ã';
        } catch(e){}
    }

    async function render() {
        dom.list.innerHTML='';
        const arr = [];
        
        if(isDir && folderH) {
            for await (const [n,h] of folderH.entries()) {
                if(h.kind=='file' && n.toUpperCase().match(/\.(PRSH|PRSHX|TXT)$/)) arr.push(h);
            }
        } else if(!isDir) {
            arr.push(...handlesCache);
        }

        if(arr.length==0) return dom.list.innerHTML='<li style="padding:15px;color:#666;text-align:center">–ü—É—Å—Ç–æ</li>';

        arr.sort((a,b)=>a.name.localeCompare(b.name)).forEach(h => {
            const li = document.createElement('li');
            li.className='file-item';
            const ico = h.name.match(/\.PRSHX/i) ? 'üß©':'üìÑ';
            li.innerHTML = `<span>${ico} ${h.name}</span> <span class="del-btn">‚úï</span>`;
            
            li.onclick = (e) => {
                if(e.target.className=='del-btn') return;
                loadFile(h);
                document.querySelectorAll('.file-item').forEach(x=>x.classList.remove('active'));
                li.classList.add('active');
            }
            li.querySelector('.del-btn').onclick = async () => {
                if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
                if(isDir) await folderH.removeEntry(h.name);
                else handlesCache = handlesCache.filter(x=>x!==h);
                if(fileH && fileH.name==h.name) clean();
                render();
            };
            dom.list.appendChild(li);
        });
    }

    async function loadFile(h) {
        try {
            fileH = h;
            const f = await h.getFile();
            dom.ed.value = await f.text();
            dom.tab.textContent = h.name;
            dom.stat.textContent = '–§–∞–π–ª: '+h.name;
            syncLayout(); // –í–ê–ñ–ù–û –≤—ã–∑–≤–∞—Ç—å –∑–¥–µ—Å—å
        } catch(e){alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è')}
    }

    async function saveDoc() {
        if(!fileH) return alert('–ù–µ—Ç —Ñ–∞–π–ª–∞');
        try {
            const w = await fileH.createWritable();
            await w.write(dom.ed.value);
            await w.close();
            dom.stat.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            setTimeout(()=>dom.stat.textContent='...', 2000);
        } catch(e){alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')}
    }

    function newFileAsk() {
        if(!isDir) return alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É —Å–Ω–∞—á–∞–ª–∞');
        dom.mod.style.display='flex';
        dom.inp.value=''; dom.inp.focus();
    }
    
    async function createYes() {
        let n = dom.inp.value.trim();
        if(!n) return;
        if(!n.toUpperCase().match(/\.(PRSH|PRSHX)$/)) n+='.PRSH';
        try {
            const nh = await folderH.getFileHandle(n, {create:true});
            const w = await nh.createWritable();
            await w.write(`–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {\n    \n}`); 
            await w.close();
            dom.mod.style.display='none';
            await render();
            loadFile(nh);
        } catch(e){alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è')}
    }

    // Ctrl+S
    document.addEventListener('keydown', e=>{
        if(e.ctrlKey && e.key=='s'){e.preventDefault();saveDoc();}
    });

</script>
</body>
</html>
