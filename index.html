<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode Editor v1.7</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --gutter-text: #858585;
            --text-color: #cccccc;
            --accent-color: #007acc;
            --header-height: 45px;
            --font-family: 'Consolas', 'Courier New', monospace;
            --font-size: 14px;
            --line-height: 20px;
        }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            height: var(--header-height); background-color: #333;
            display: flex; align-items: center; padding: 0 15px;
            justify-content: space-between; user-select: none;
            border-bottom: 1px solid #111;
        }

        .controls { display: flex; align-items: center; gap: 10px; }
        
        .btn {
            border: none; color: white; padding: 6px 14px;
            border-radius: 3px; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-primary { background-color: var(--accent-color); font-weight: bold;}
        .btn-primary:hover { background-color: #005fa3; }
        .btn-secondary { background-color: #4d4d4d; }
        .btn-secondary:hover { background-color: #666; }
        .btn-success { background-color: #2da042; }
        .btn-success:hover { background-color: #238535; }

        .workspace {
            display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px);
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background-color: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        
        .sidebar-header {
            padding: 12px 15px; 
            font-size: 11px; 
            font-weight: bold; 
            color: #ccc; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            display: flex; 
            justify-content: space-between;
            background-color: #2b2b2c;
            border-bottom: 1px solid #333;
        }

        .file-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex:1;}
        .file-item { 
            padding: 5px 15px; cursor: pointer; display: flex; 
            justify-content: space-between; color:#bbb; align-items:center; 
            font-size:13px; border-left: 3px solid transparent;
        }
        .file-item:hover { background: #2a2d2e; color: #fff;}
        .file-item.active { background: #37373d; border-left-color: var(--accent-color); color: white;}

        /* EDITOR */
        .editor-container {
            flex: 1; display: flex; flex-direction: column;
            background: var(--bg-color); position: relative;
        }

        .tab-bar { 
            height: 30px; background: #252526; display: flex; align-items: center; 
            border-bottom: 1px solid #111;
        }
        .tab { 
            padding: 0 15px; height: 100%; display: flex; align-items: center; 
            background: #1e1e1e; color: #fff; font-size: 12px; 
            border-top: 2px solid var(--accent-color);
            border-right: 1px solid #252526;
        }

        .code-area { flex: 1; display: flex; position: relative; overflow: hidden; }

        .gutter {
            width: 45px; background: #1e1e1e; color: #6e7681;
            text-align: right; border-right: 1px solid #333; user-select: none;
            padding-top: 10px; box-sizing: border-box; overflow: hidden;
        }
        .line-number {
            font-size: var(--font-size); font-family: var(--font-family);
            line-height: var(--line-height); padding-right: 10px; box-sizing: border-box;
        }

        textarea#editor {
            flex: 1; background: transparent; color: #d4d4d4; border: none;
            resize: none; padding: 10px;
            font-family: var(--font-family); font-size: var(--font-size);
            line-height: var(--line-height);
            outline: none; white-space: pre-wrap; overflow-y: scroll;
            overflow-x: hidden; box-sizing: border-box; z-index: 2;
        }

        #size-calculator {
            visibility: hidden; position: absolute; top: -9999px; left: -9999px;
            width: calc(100% - 55px); padding: 10px; box-sizing: border-box;
            font-family: var(--font-family); font-size: var(--font-size);
            line-height: var(--line-height); white-space: pre-wrap; word-wrap: break-word;
        }

        footer { 
            height: 25px; background: var(--accent-color); 
            display: flex; align-items: center; padding: 0 15px; color: white; font-size: 11px; 
        }

        .delete-btn { opacity: 0; font-weight: bold; margin-left: 10px; transition: 0.2s;}
        .file-item:hover .delete-btn { opacity: 1; color: #aaa; }
        .delete-btn:hover { color: #f55; }

        /* MODAL */
        .modal-overlay { 
            display: none; position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:99;
        }
        .modal { background:#252526; padding:20px; border-radius:5px; text-align:center; box-shadow:0 5px 20px rgba(0,0,0,0.5); width: 300px; border: 1px solid #444;}
        .modal input { 
            background: #3c3c3c; color: white; border:1px solid #555; 
            padding:8px; width:90%; margin-bottom: 15px; margin-top: 5px; outline: none;
        }
        .modal h3 { margin-top: 0; color: #ccc;}
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; color: white; margin-right: 10px;">Roode <span style="opacity:0.5; font-size: 11px;">1.7 (Clear)</span></div>
    
    <div class="controls">
        <button class="btn btn-primary" onclick="openFolderHandle()" title="–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É">
            üìÇ –û–¢–ö–†–´–¢–¨ –ü–ê–ü–ö–£
        </button>

        <button class="btn btn-success" onclick="tryCreateFile()">
            ‚ûï –°–æ–∑–¥–∞—Ç—å
        </button>

        <button class="btn btn-secondary" onclick="saveFileHandle()">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>

        <div style="width: 1px; height: 20px; background: #555; margin: 0 5px;"></div>

        <button class="btn btn-secondary" style="font-size:11px; padding: 4px 8px;" onclick="openFilesHandle()" title="–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤">
            üìÑ –æ—Ç–¥. —Ñ–∞–π–ª—ã
        </button>
    </div>
</header>

<div class="workspace">
    <!-- LEFT -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span id="folderLabel">–ü–†–û–í–û–î–ù–ò–ö</span>
            <span onclick="refreshFileList()" style="cursor:pointer;" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</span>
        </div>
        <ul id="fileList" class="file-list">
            <li style="padding:20px 10px; text-align:center; color:#555; font-size:12px; line-height: 1.5;">
                –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–∞–ø–æ–∫
            </li>
        </ul>
    </div>

    <!-- RIGHT -->
    <div class="editor-container">
        <div class="tab-bar">
            <div class="tab" id="currentFileName">–ù–µ—Ç —Ñ–∞–π–ª–∞</div>
        </div>
        
        <div class="code-area">
            <div id="gutter" class="gutter"><div class="line-number">1</div></div>
            <textarea id="editor" spellcheck="false" placeholder="–ö–æ–¥ –∑–∞–∫—Ä—ã—Ç.
1. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤ –º–µ–Ω—é —Å–ª–µ–≤–∞.
2. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚ûï –°–æ–∑–¥–∞—Ç—å'."></textarea>
            <div id="size-calculator"></div>
        </div>
    </div>
</div>

<footer>
    <div id="statusbar">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
</footer>

<div class="modal-overlay" id="createModal">
    <div class="modal">
        <h3>–ù–æ–≤—ã–π —Ñ–∞–π–ª</h3>
        <input type="text" id="newFilenameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (main.PRSH)">
        <div>
            <button class="btn btn-success" onclick="finalizeCreation()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="document.getElementById('createModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
    let folderHandle = null; 
    let activeFileHandle = null; 
    let isFolderMode = false;

    const els = {
        editor: document.getElementById('editor'),
        gutter: document.getElementById('gutter'),
        calc: document.getElementById('size-calculator'),
        list: document.getElementById('fileList'),
        tabName: document.getElementById('currentFileName'),
        status: document.getElementById('statusbar'),
        modal: document.getElementById('createModal'),
        filenameInput: document.getElementById('newFilenameInput'),
        folderLabel: document.getElementById('folderLabel')
    };

    // 1. –û–¢–ö–†–´–¢–ò–ï –ü–ê–ü–ö–ò (–° –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º)
    async function openFolderHandle() {
        try {
            const newHandle = await window.showDirectoryPicker();
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –Ω–æ–≤—É—é –ø–∞–ø–∫—É, –∫–æ–¥ –Ω–∏–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:
            
            // –°–ù–ê–ß–ê–õ–ê –ó–ê–ö–†–´–í–ê–ï–ú –°–¢–ê–†–´–ô –§–ê–ô–õ
            clearEditor();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é –ø–∞–ø–∫—É
            folderHandle = newHandle;
            isFolderMode = true;
            els.folderLabel.textContent = folderHandle.name.toUpperCase();
            els.status.textContent = `–ü–∞–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞: ${folderHandle.name}`;
            
            await refreshFileList();
            
        } catch(e) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –û—Ç–º–µ–Ω–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            console.log("–û—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏");
        }
    }

    // 2. –û–¢–ö–†–´–¢–ò–ï –û–¢–î–ï–õ–¨–ù–´–• –§–ê–ô–õ–û–í
    async function openFilesHandle() {
        try {
            const handles = await window.showOpenFilePicker({
                multiple: true,
                types: [{description: 'Code', accept: {'text/plain': ['.PRSH','.PRSHX','.txt']}}]
            });
            
            clearEditor(); // –¢–æ–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞
            
            isFolderMode = false;
            folderHandle = null;
            els.folderLabel.textContent = "–í–´–ë–†–ê–ù–ù–´–ï –§–ê–ô–õ–´";
            els.status.textContent = "–†–µ–∂–∏–º —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤";
            renderFilesList(handles);
        } catch(e) {}
    }

    // 3. –ü–û–õ–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –§–ê–ô–õ–ê –í –†–ï–î–ê–ö–¢–û–†–ï
    function clearEditor() {
        activeFileHandle = null;           // –ó–∞–±—ã–ª–∏ —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª
        els.editor.value = '';             // –°—Ç–µ—Ä–ª–∏ —Ç–µ–∫—Å—Ç
        els.tabName.textContent = "–ù–µ—Ç —Ñ–∞–π–ª–∞"; 
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–∞ (–µ—Å–ª–∏ –æ–Ω –±—ã–ª)
        const allItems = document.querySelectorAll('.file-item');
        allItems.forEach(i => i.classList.remove('active'));
        
        updateLineNumbers();
        els.status.textContent = "–†–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –æ—á–∏—â–µ–Ω–æ";
    }

    // --- –§–£–ù–ö–¶–ò–ò –§–ê–ô–õ–û–í–û–ô –°–ò–°–¢–ï–ú–´ ---

    async function refreshFileList() {
        if (!folderHandle) return;
        const files = [];
        for await (const [name, handle] of folderHandle.entries()) {
            if (handle.kind === 'file') {
                const upper = name.toUpperCase();
                if(upper.endsWith('.PRSH') || upper.endsWith('.PRSHX') || upper.endsWith('.TXT')) {
                    files.push(handle);
                }
            }
        }
        files.sort((a,b) => a.name.localeCompare(b.name));
        renderFilesList(files);
    }

    function renderFilesList(handles) {
        els.list.innerHTML = '';
        if(handles.length === 0) {
            els.list.innerHTML = '<li style="padding:15px;text-align:center;color:#666;">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ RuPL</li>';
            return;
        }
        handles.forEach(h => {
            const li = document.createElement('li');
            li.className = 'file-item';
            
            let icon = 'üìÑ';
            if(h.name.toUpperCase().endsWith('.PRSHX')) icon = 'üß©';

            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span style="margin-right:8px; opacity:0.7">${icon}</span> ${h.name}
                </div>
                <div class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å">üóë</div>
            `;
            li.onclick = (e) => {
                if(!e.target.classList.contains('delete-btn')) loadFile(h);
            };
            li.querySelector('.delete-btn').onclick = async (e) => {
                e.stopPropagation();
                if(confirm(`–£–¥–∞–ª–∏—Ç—å ${h.name} –Ω–∞–≤—Å–µ–≥–¥–∞?`)) {
                    if(isFolderMode && folderHandle) {
                        try {
                            await folderHandle.removeEntry(h.name);
                            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–æ—Ç —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç - –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                            if(activeFileHandle && activeFileHandle.name === h.name) clearEditor();
                            refreshFileList();
                        } catch(err) { alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"); }
                    } else {
                        li.remove();
                    }
                }
            };
            els.list.appendChild(li);
        });
    }

    async function loadFile(handle) {
        try {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ –º–µ–Ω—é
            const allItems = document.querySelectorAll('.file-item');
            allItems.forEach(i => i.classList.remove('active'));
            // –ü—Ä–æ—Ö–æ–¥–∏–º —Ü–∏–∫–ª–æ–º, —Ç–∞–∫ –∫–∞–∫ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞—Ç—Ä–∞—Ç–Ω–æ, –Ω–æ —Ç–∞–∫ –ø—Ä–æ—â–µ
            // –í –∏–¥–µ–∞–ª–µ –º—ã –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ LI, –Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ reference —Ç–µ—Ä—è–µ—Ç—Å—è
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
            if(isFolderMode) await refreshFileList(); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
            
            // –ù–∞—Ö–æ–¥–∏–º LI –ø–æ –∏–º–µ–Ω–∏ –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
            const listItems = els.list.querySelectorAll('.file-item');
            listItems.forEach(li => {
                if(li.textContent.includes(handle.name)) li.classList.add('active');
            });

            const file = await handle.getFile();
            els.editor.value = await file.text();
            activeFileHandle = handle;
            els.tabName.textContent = handle.name;
            els.status.textContent = "–†–µ–¥–∞–∫—Ç–æ—Ä: " + handle.name;
            updateLineNumbers();
        } catch(e) {
            console.error(e);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª.");
        }
    }

    async function saveFileHandle() {
        if (!activeFileHandle) return alert("–§–∞–π–ª –Ω–µ –æ—Ç–∫—Ä—ã—Ç!");
        try {
            const writable = await activeFileHandle.createWritable();
            await writable.write(els.editor.value);
            await writable.close();
            els.status.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: " + new Date().toLocaleTimeString();
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
    }

    function tryCreateFile() {
        if(!isFolderMode || !folderHandle) {
            if(confirm("–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –Ω—É–∂–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞—è –ü–ê–ü–ö–ê. –í—ã–±—Ä–∞—Ç—å?")) openFolderHandle();
            return;
        }
        els.modal.style.display = 'flex';
        els.filenameInput.focus();
    }

    async function finalizeCreation() {
        let name = els.filenameInput.value.trim();
        if(!name) return;
        if(!name.toUpperCase().match(/\.(PRSH|PRSHX)$/)) name += '.PRSH';
        const tmpl = `–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {
    // RuPL Code
}`;
        try {
            const newHandle = await folderHandle.getFileHandle(name, {create: true});
            const writable = await newHandle.createWritable();
            await writable.write(tmpl);
            await writable.close();
            els.modal.style.display = 'none';
            els.filenameInput.value = '';
            
            await refreshFileList();
            // –°—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
            loadFile(newHandle); 
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è"); }
    }

    // VISUALS
    function updateLineNumbers() {
        const text = els.editor.value;
        const lines = text.split('\n');
        els.calc.style.width = els.editor.clientWidth + 'px';
        els.calc.innerHTML = '';
        let html = '';
        lines.forEach((l, i) => {
            const div = document.createElement('div');
            div.textContent = l || ' ';
            els.calc.appendChild(div);
            html += `<div class="line-number" style="height:${div.offsetHeight}px">${i+1}</div>`;
        });
        els.gutter.innerHTML = html;
    }

    els.editor.addEventListener('input', updateLineNumbers);
    els.editor.addEventListener('scroll', () => els.gutter.scrollTop = els.editor.scrollTop);
    window.addEventListener('resize', updateLineNumbers);

    setTimeout(updateLineNumbers, 50);

    document.addEventListener('keydown', e => {
        if(e.ctrlKey && e.key === 's') { e.preventDefault(); saveFileHandle(); }
    });
</script>
</body>
</html>
