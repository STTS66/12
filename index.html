<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode v2.4 (Fix Dupes)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --line-number-color: #858585;
            --header-height: 40px;
            --menu-hover: #094771;
            
            --editor-font: 'Consolas', 'Monaco', 'Courier New', monospace;
            --editor-size: 14px;
            --editor-line-height: 20px; 
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: -apple-system, sans-serif; }

        /* HEADER */
        header { height: var(--header-height); background: #333; display: flex; align-items: center; padding: 0 10px; justify-content: space-between; border-bottom: 1px solid #111; user-select: none; z-index: 20; }
        .controls { display: flex; gap: 6px; position: relative; }
        .logo { font-weight: bold; color: white; margin-right: 10px; font-size: 14px;}
        .btn { border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; color: white; font-size: 11px; display: flex; align-items: center; transition: 0.2s; white-space: nowrap; }
        .btn-blue { background: var(--accent-color); } .btn-blue:hover{background:#0062a3;}
        .btn-green { background: #238636; } .btn-green:hover{background:#2ea043;}
        .btn-gray { background: #444; } .btn-gray:hover{background:#555;}
        
        /* MENU */
        .dropdown { position: absolute; top: 30px; right: 0; background: #252526; border: 1px solid #454545; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: none; flex-direction: column; min-width: 150px; z-index: 100; }
        .dropdown.show { display: flex; }
        .dropdown-item { padding: 8px 12px; font-size: 12px; cursor: pointer; color: #ccc; border-bottom: 1px solid #333; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: var(--menu-hover); color: white; }

        /* WORKSPACE */
        .workspace { display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px); }
        .sidebar { width: 250px; background: var(--sidebar-color); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px 15px; font-size: 11px; font-weight: bold; color: #aaa; text-transform: uppercase; background: #2b2b2c; display: flex; justify-content: space-between; }
        .file-list { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .file-item { padding: 4px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #ccc; cursor: pointer; border-left: 3px solid transparent; }
        .file-item:hover { background: #2a2d2e; }
        .file-item.active { background: #37373d; border-left-color: var(--accent-color); color: #fff; }
        .del-btn { opacity: 0; color: #666; font-weight: bold; margin-left: 5px; }
        .file-item:hover .del-btn { opacity: 1; } .del-btn:hover { color: #f44; }

        .editor-container { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-color); min-width: 0; }
        .tab-bar { height: 35px; background: #252526; display: flex; align-items: center; }
        .tab { padding: 0 15px; height: 100%; display: flex; align-items: center; background: #1e1e1e; font-size: 13px; border-top: 2px solid var(--accent-color); }

        .code-wrapper { flex: 1; display: flex; position: relative; overflow: hidden; }
        .gutter { width: 45px; flex-shrink: 0; background: #1e1e1e; color: var(--line-number-color); text-align: right; border-right: 1px solid #333; user-select: none; overflow: hidden; padding-top: 10px; box-sizing: border-box; }
        .line-num { height: var(--editor-line-height); line-height: var(--editor-line-height); font-family: var(--editor-font); font-size: var(--editor-size); padding-right: 8px; }
        textarea#editor { flex: 1; background: transparent; border: none; outline: none; resize: none; color: var(--text-color); padding: 10px; box-sizing: border-box; font-family: var(--editor-font); font-size: var(--editor-size); line-height: var(--editor-line-height); tab-size: 4; white-space: pre; overflow-x: scroll; overflow-y: scroll; }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; }

        footer { height: 25px; background: var(--accent-color); display: flex; align-items: center; padding: 0 15px; color: white; font-size: 11px; }

        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:99;}
        .modal { background: #252526; padding: 20px; width: 300px; border:1px solid #444; text-align:center;}
        .modal input { width: 90%; padding: 5px; margin: 10px 0; background: #3c3c3c; border: 1px solid #555; color: #fff;}
    </style>
</head>
<body>

<header>
    <div class="logo">Roode <span style="font-size:10px;opacity:0.5">2.4</span></div>
    <div class="controls">
        <button class="btn btn-blue" onclick="selFolder()">üìÇ –ü–∞–ø–∫–∞</button>
        <button class="btn btn-green" onclick="showNew()">‚ûï</button>
        <button class="btn btn-gray" onclick="save()">üíæ Save All</button>
        <button class="btn btn-gray" onclick="selFiles()">üìÑ –§–∞–π–ª—ã</button>
        <button class="btn btn-gray" style="font-size: 14px; font-weight: bold; padding: 2px 10px;" onclick="toggleMenu(event)">‚Ä¢‚Ä¢‚Ä¢</button>
        <div id="mainMenu" class="dropdown">
            <div class="dropdown-item" onclick="saveAs()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫...</div>
            <div class="dropdown-item" onclick="exportTxt()">–°–∫–∞—á–∞—Ç—å .txt</div>
            <div class="dropdown-item" style="color:#ff6b6b" onclick="closeAll()">–ó–∞–∫—Ä—ã—Ç—å –≤—Å—ë</div>
        </div>
    </div>
</header>

<div class="workspace">
    <div class="sidebar">
        <div class="sidebar-header">
            <span id="labelHeader">–ü–†–û–í–û–î–ù–ò–ö</span>
            <span style="cursor:pointer" onclick="listRender()">‚Üª</span>
        </div>
        <ul id="listUI" class="file-list"></ul>
    </div>
    <div class="editor-container">
        <div class="tab-bar"><div class="tab" id="tabInfo">...</div></div>
        <div class="code-wrapper">
            <div id="gutter" class="gutter"></div>
            <textarea id="editor" spellcheck="false" placeholder="// Roode v2.4 (Fix Duplicates)"></textarea>
        </div>
    </div>
</div>

<footer><div id="msg">–ì–æ—Ç–æ–≤</div></footer>

<div class="overlay" id="mod"><div class="modal">
    <h3>–ù–æ–≤—ã–π —Ñ–∞–π–ª</h3>
    <!-- –ó–∞—â–∏—Ç–∞ –æ—Ç Enter, —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Enter –≤ JS –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ -->
    <input id="fname" placeholder="name.PRSH"><br>
    <button class="btn btn-blue" id="btnOk" onclick="createFile()">OK</button>
    <button class="btn btn-gray" onclick="document.getElementById('mod').style.display='none'">X</button>
</div></div>

<script>
    let fHandle = null, fileH = null, isDir = false;
    let filesCache = [];
    let projectMemory = {}; 
    let isCreating = false; // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è

    const ed = document.getElementById('editor');
    const gut = document.getElementById('gutter');
    const ui = document.getElementById('listUI');
    const msg = document.getElementById('msg');
    const tab = document.getElementById('tabInfo');
    const label = document.getElementById('labelHeader');
    const menu = document.getElementById('mainMenu');

    // Numbers & Events
    function updateLines() {
        const linesCount = ed.value.split('\n').length;
        let html = '';
        for(let i=0; i < linesCount; i++){ html += `<div class="line-num">${i+1}</div>`; }
        gut.innerHTML = html;
    }
    ed.addEventListener('input', () => {
        updateLines();
        if(!isDir && fileH) projectMemory[fileH.name] = ed.value;
    });
    ed.addEventListener('scroll', () => { gut.scrollTop = ed.scrollTop; });
    ed.addEventListener('keydown', ()=> setTimeout(updateLines,0));
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
    document.getElementById('fname').addEventListener('keydown', function(e){
        if(e.key === 'Enter') createFile();
    });

    // Menu
    function toggleMenu(e) { e.stopPropagation(); menu.classList.toggle('show'); }
    window.addEventListener('click', () => menu.classList.remove('show'));

    // --- LOGIC ---

    async function saveAs() {
        try {
            const options = {
                types: [{description: 'RuPL File', accept: {'text/plain': ['.PRSH', '.PRSHX']}}],
                suggestedName: fileH ? fileH.name : 'Untitled.PRSH'
            };
            const newHandle = await window.showSaveFilePicker(options);
            const w = await newHandle.createWritable();
            await w.write(ed.value); await w.close();
            notify(`Saved as: ${newHandle.name}`);
            if(!isDir) { filesCache.push(newHandle); projectMemory[newHandle.name] = ed.value; }
            // –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–π
            listRender();
            load(newHandle);
        } catch (err) {}
    }

    function exportTxt() {
        const blob = new Blob([ed.value], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (fileH ? fileH.name : 'code') + '.txt';
        a.click();
    }
    
    function closeAll() {
        if(!confirm("–ó–∞–∫—Ä—ã—Ç—å –≤—Å—ë?")) return;
        projectMemory = {}; filesCache = []; fHandle = null; isDir = false;
        label.textContent = "–ü–†–û–í–û–î–ù–ò–ö"; resetEd(); listRender();
    }

    async function selFolder() {
        try {
            fHandle = await window.showDirectoryPicker();
            isDir = true; label.textContent = fHandle.name.toUpperCase();
            projectMemory = {}; filesCache = []; resetEd(); listRender();
        } catch(e){}
    }

    async function selFiles() {
        try {
            filesCache = await window.showOpenFilePicker({multiple:true, types:[{description:'Code',accept:{'text/plain':['.prsh','.prshx','.txt']}}]});
            isDir = false; fHandle = null; label.textContent = "–§–ê–ô–õ–´ –í –ü–ê–ú–Ø–¢–ò";
            resetEd(); projectMemory = {};
            for (let h of filesCache) { const f = await h.getFile(); projectMemory[h.name] = await f.text(); }
            listRender();
        } catch(e){}
    }

    function resetEd() { fileH = null; ed.value = ''; tab.textContent = "---"; updateLines(); }

    async function listRender() {
        ui.innerHTML = '';
        let list = [];
        if(isDir && fHandle) {
            for await (const [n, h] of fHandle.entries()) {
                if(h.kind==='file' && n.toUpperCase().match(/\.(PRSH|PRSHX|TXT)$/)) list.push(h);
            }
        } else if(!isDir) list = [...filesCache];

        list.sort((a,b)=>a.name.localeCompare(b.name)).forEach(h => {
            const li = document.createElement('li');
            li.className='file-item';
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º dataset –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            li.dataset.name = h.name; 
            
            if(fileH && fileH.name===h.name) li.classList.add('active');
            
            const ico = h.name.match(/X$/i)?'üß©':'üìÑ';
            li.innerHTML = `<span>${ico} ${h.name}</span><span class="del-btn">üóë</span>`;
            li.onclick = (e) => { if(!e.target.className.includes('del')) load(h); };
            li.querySelector('.del-btn').onclick = async()=>{
                if(!confirm('–£–±—Ä–∞—Ç—å?'))return;
                if(isDir) await fHandle.removeEntry(h.name);
                else { filesCache = filesCache.filter(x=>x!=h); delete projectMemory[h.name]; }
                if(fileH && fileH.name == h.name) resetEd();
                listRender();
            };
            ui.appendChild(li);
        });
    }

    async function load(h) {
        fileH = h;
        // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò:
        // –ù–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ (listRender), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º–µ—Ä—Ü–∞–Ω–∏–π
        // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
        const items = document.querySelectorAll('.file-item');
        items.forEach(li => {
            li.classList.remove('active');
            if(li.dataset.name === h.name) li.classList.add('active');
        });

        if(isDir) { const f = await h.getFile(); ed.value = await f.text(); } 
        else { ed.value = projectMemory[h.name] || ""; }
        tab.textContent = h.name; msg.textContent = h.name; updateLines();
    }

    async function save() {
        if(isDir) {
            if(!fileH) return alert('–ù–µ—Ç —Ñ–∞–π–ª–∞');
            const w = await fileH.createWritable(); await w.write(ed.value); await w.close();
            notify(`Saved: ${fileH.name}`);
        } else {
            if(filesCache.length === 0) return alert("–ü—É—Å—Ç–æ");
            if(fileH) projectMemory[fileH.name] = ed.value;
            try {
                let c = 0;
                for(let h of filesCache) {
                    const ct = projectMemory[h.name];
                    if(ct!==undefined) { const w = await h.createWritable(); await w.write(ct); await w.close(); c++; }
                }
                notify(`‚úÖ Updated ${c} files`);
            } catch(e) { alert("Err: " + e.message); }
        }
    }

    function notify(txt) { msg.textContent = txt; setTimeout(()=>msg.textContent='–ì–æ—Ç–æ–≤', 3000); }
    function showNew(){ 
        if(!isDir) return alert('–¢–æ–ª—å–∫–æ –¥–ª—è –ø–∞–ø–æ–∫'); 
        document.getElementById('fname').value = ''; // –ß–∏—Å—Ç–∏–º –ø–æ–ª–µ
        document.getElementById('mod').style.display='block'; 
        document.getElementById('fname').focus();
    }
    
    async function createFile(){
        if(isCreating) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∫–ª–∏–∫–æ–≤
        
        let n = document.getElementById('fname').value; 
        if(!n) return;
        if(!n.match(/\./)) n+='.PRSH';

        isCreating = true; // –ë–ª–æ–∫
        
        try {
            const nh = await fHandle.getFileHandle(n,{create:true});
            const w = await nh.createWritable(); await w.write('–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {\n\n}'); await w.close();
            
            document.getElementById('mod').style.display='none';
            
            // –í–ê–ñ–ù–û: –ü–æ—Ä—è–¥–æ–∫ –≤—ã–∑–æ–≤–æ–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥—É–±–ª–µ–π
            // 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å –¥–∏—Å–∫–∞
            await listRender();
            // 2. –ü–æ—Ç–æ–º –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª (–æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ)
            await load(nh);
            
        } catch(e) {
            console.error(e);
        } finally {
            isCreating = false; // –†–∞–∑–±–ª–æ–∫
        }
    }
    
    document.addEventListener('keydown', e=>{if(e.ctrlKey&&e.key=='s'){e.preventDefault();save()}});
</script>
</body>
</html>
