<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roode Editor v1.9.2 (Wrap Fix)</title>
    <style>
        :root {
            /* –ù–ê–°–¢–†–û–ô–ö–ò */
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --line-number-color: #858585;
            --header-height: 40px;
            
            /* –ï–î–ò–ù–´–ô –®–†–ò–§–¢ –î–õ–Ø –í–°–ï–ì–û */
            --editor-font: 'Consolas', 'Monaco', 'Courier New', monospace;
            --editor-size: 14px;
            --editor-line-height: 20px; 
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color); color: var(--text-color);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; font-family: -apple-system, sans-serif;
        }

        /* HEADER */
        header {
            height: var(--header-height); background: #333;
            display: flex; align-items: center; padding: 0 10px;
            justify-content: space-between; border-bottom: 1px solid #111; user-select: none;
        }

        .logo { 
            font-weight: 700; color: #fff; letter-spacing: 0.5px; 
            font-size: 14px; margin-right: 5px;
        }
        .controls { display: flex; gap: 4px; }
        .btn {
            border: none; padding: 4px 10px; border-radius: 3px; cursor: pointer; color: white; 
            font-size: 11px; font-weight: 500; display: flex; align-items: center; 
            white-space: nowrap; transition: 0.2s;
        }
        .btn-blue { background: var(--accent-color); }
        .btn-blue:hover { background: #0062a3; }
        .btn-green { background: #238636; border: 1px solid rgba(240,246,252,0.1); }
        .btn-green:hover { background: #2ea043; }
        .btn-gray { background: #444; }
        .btn-gray:hover { background: #555; }
        .btn-icon { padding: 4px 8px; font-size: 14px; }

        .workspace { display: flex; flex: 1; height: calc(100vh - var(--header-height) - 25px); }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: var(--sidebar-color);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 12px 15px; font-size: 11px; font-weight: bold; color: #aaa;
            text-transform: uppercase; background: #2b2b2c; display: flex; justify-content: space-between;
        }
        .file-list { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .file-item {
            padding: 5px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: #ccc; cursor: pointer; border-left: 3px solid transparent;
        }
        .file-item:hover { background: #2a2d2e; color: #fff; }
        .file-item.active { background: #37373d; border-left-color: var(--accent-color); color: #fff; }
        .del-btn { opacity: 0; font-weight: bold; color: #777; padding: 0 5px;}
        .file-item:hover .del-btn { opacity: 1; }
        .del-btn:hover { color: #f44; }

        /* EDITOR CONTAINER */
        .editor-container {
            flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-color);
        }
        .tab-bar { height: 35px; background: #252526; display: flex; align-items: center; border-bottom: 1px solid #111; }
        .tab { 
            padding: 0 15px; height: 100%; display: flex; align-items: center;
            background: #1e1e1e; font-size: 13px; border-top: 2px solid var(--accent-color);
        }

        /* --- SYNC & WRAPPING FIX --- */
        .code-wrapper {
            flex: 1; display: flex; position: relative; overflow: hidden;
        }

        .gutter {
            width: 50px; flex-shrink: 0;
            background: #1e1e1e; color: var(--line-number-color);
            text-align: right; border-right: 1px solid #333;
            user-select: none; padding-top: 10px;
            box-sizing: border-box; overflow: hidden;
        }
        
        /* –ë–ª–æ–∫, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É */
        .line-box {
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
            padding-right: 10px;
            /* –í—ã—Å–æ—Ç–∞ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –±—É–¥–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞ JS */
        }

        textarea#editor {
            flex: 1;
            background: transparent; border: none; outline: none; resize: none;
            color: var(--text-color);
            padding: 10px;
            box-sizing: border-box;
            
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
            tab-size: 4;
            
            /* –ö–õ–Æ–ß–ï–í–û–ô –§–ò–ö–°: –ó–ê–°–¢–ê–í–õ–Ø–ï–ú –ü–ï–†–ï–ù–û–°–ò–¢–¨ –í–ï–ó–î–ï –û–î–ò–ù–ê–ö–û–í–û */
            white-space: pre-wrap;       
            overflow-wrap: anywhere;  /* –°–∞–º—ã–π –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å (–¥–ª—è —Ö–µ—à—Ç–µ–≥–æ–≤ –∏ —Ç–¥) */
            word-break: break-word;   
            
            overflow-y: scroll; 
        }

        /* –¢–µ–Ω–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ */
        #ghost-calc {
            position: absolute; top: 0; left: 0; visibility: hidden; pointer-events: none; z-index: -99;
            background: red; 
            padding: 10px; box-sizing: border-box;
            
            /* –°—Ç–∏–ª—å –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è —Å textarea */
            font-family: var(--editor-font);
            font-size: var(--editor-size);
            line-height: var(--editor-line-height);
            
            /* –≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å –Ω–∞ 100% —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º */
            white-space: pre-wrap;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        footer { height: 25px; background: var(--accent-color); display: flex; align-items: center; padding: 0 15px; color: white; font-size: 11px; }

        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:999;}
        .modal { background: #252526; padding: 25px; width: 300px; border-radius: 5px; box-shadow: 0 10px 30px #000; border:1px solid #444; text-align:center;}
        .modal input { width: 100%; padding: 8px; margin: 15px 0; background: #3c3c3c; border: 1px solid #555; color: #fff; box-sizing: border-box; outline:none;}
    </style>
</head>
<body>

<header>
    <div class="logo">Roode <span style="font-weight:normal;opacity:0.5; font-size:10px;">v1.9.2</span></div>
    
    <div class="controls">
        <button class="btn btn-blue" onclick="chooseFolder()" title="–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É">üìÇ –ü–∞–ø–∫–∞</button>
        <button class="btn btn-green" onclick="newFileAsk()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn btn-gray btn-icon" onclick="saveDoc()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
        <div style="width:1px; background:#444; height:18px; margin:0 2px;"></div>
        <button class="btn btn-gray" onclick="chooseFiles()">üìÑ –û—Ç–¥.–§–∞–π–ª—ã</button>
    </div>
</header>

<div class="workspace">
    <div class="sidebar">
        <div class="sidebar-header">
            <span id="projTitle">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</span>
            <span style="cursor:pointer" onclick="render()">‚Üª</span>
        </div>
        <ul id="tree" class="file-list">
            <li style="padding:15px; text-align:center; color:#555;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>
        </ul>
    </div>

    <div class="editor-container">
        <div class="tab-bar">
            <div class="tab" id="tabTitle">–ü—É—Å—Ç–æ</div>
        </div>
        
        <div class="code-wrapper">
            <!-- –°—Ç–æ–ª–±–∏–∫ —Ü–∏—Ñ—Ä -->
            <div id="gutter" class="gutter"></div>
            
            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <textarea id="editor" spellcheck="false" placeholder="// –í—Å—Ç–∞–≤—å —Å–≤–æ–π –∫–æ–¥ —Å—é–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∞..."></textarea>
            
            <!-- –ü—Ä–∏–∑—Ä–∞–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã—Å–æ—Ç—ã -->
            <div id="ghost-calc"></div>
        </div>
    </div>
</div>

<footer>
    <div id="stat">–ì–æ—Ç–æ–≤</div>
</footer>

<div class="overlay" id="modal">
    <div class="modal">
        <h3 style="color:#ddd; margin:0">–ò–º—è —Ñ–∞–π–ª–∞</h3>
        <input id="fname" placeholder="script.PRSH" onkeydown="if(event.key==='Enter') createYes()">
        <button class="btn btn-blue" onclick="createYes()">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn btn-gray" onclick="document.getElementById('modal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    // –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    let folderH = null;
    let fileH = null;
    let isDir = false;
    let handlesCache = [];

    // –≠–õ–ï–ú–ï–ù–¢–´ DOM
    const dom = {
        ed: document.getElementById('editor'),
        gut: document.getElementById('gutter'),
        gh: document.getElementById('ghost-calc'),
        list: document.getElementById('tree'),
        tit: document.getElementById('projTitle'),
        tab: document.getElementById('tabTitle'),
        stat: document.getElementById('stat'),
        mod: document.getElementById('modal'),
        inp: document.getElementById('fname')
    };

    // === –ì–õ–ê–í–ù–´–ô –§–ò–ö–° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===
    function syncLayout() {
        const val = dom.ed.value;
        const lines = val.split('\n');
        
        // 1. –£–∑–Ω–∞–µ–º —à–∏—Ä–∏–Ω—É –≤–∏–¥–∏–º–æ–π —á–∞—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (–±–µ–∑ –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
        // clientWidth –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Ç–∞–µ—Ç –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏!
        const innerWidth = dom.ed.clientWidth;
        
        // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–∑—Ä–∞–∫–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É
        const cs = getComputedStyle(dom.ed);
        
        // –ü–µ—Ä–µ–¥–∞–µ–º –ø—Ä–∏–∑—Ä–∞–∫—É —Ç—É –∂–µ —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –æ—Ç—Å—Ç—É–ø—ã
        dom.gh.style.width = innerWidth + 'px';
        dom.gh.style.padding = cs.padding;
        dom.gh.style.boxSizing = cs.boxSizing;
        
        // –ü–µ—Ä–µ–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞ –∏, —á—Ç–æ –≤–∞–∂–Ω–æ, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–Ω–æ—Å–∞
        dom.gh.style.font = cs.font;
        dom.gh.style.lineHeight = cs.lineHeight;
        dom.gh.style.letterSpacing = cs.letterSpacing;
        dom.gh.style.whiteSpace = cs.whiteSpace;    // pre-wrap
        dom.gh.style.overflowWrap = cs.overflowWrap; // anywhere (FIX)
        dom.gh.style.wordBreak = cs.wordBreak;       // break-word (FIX)

        dom.gh.innerHTML = '';
        let gutterHTML = '';

        // 3. –°—Ç—Ä–æ–∏–º –¥–≤–æ–π–Ω–∏–∫–∞
        lines.forEach((txt, idx) => {
            const d = document.createElement('div');
            // –í–∞–∂–Ω–æ! –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª, —á—Ç–æ–±—ã –æ–Ω–∞ –∏–º–µ–ª–∞ –≤—ã—Å–æ—Ç—É
            d.textContent = txt === '' ? ' ' : txt;
            
            // –ï—Å–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ –µ—Å—Ç—å –¥–ª–∏–Ω–Ω—ã–π —Å–ø–ª–æ—à–Ω–æ–π —Ç–µ–∫—Å—Ç, –ø—Ä–∏–∑—Ä–∞–∫ —Ä–∞–∑–æ–±—å–µ—Ç –µ–≥–æ 
            // —Ç–∞–∫ –∂–µ –∫–∞–∫ textarea –∏–∑-–∑–∞ —Å–≤–æ–π—Å—Ç–≤–∞ overflow-wrap: anywhere
            dom.gh.appendChild(d);
            
            // –ë–µ—Ä–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –ø–æ–ª—É—á–∏–≤—à–µ–≥–æ—Å—è –±–ª–æ–∫–∞
            const h = d.offsetHeight;
            gutterHTML += `<div class="line-box" style="height:${h}px">${idx + 1}</div>`;
        });
        
        dom.gut.innerHTML = gutterHTML;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    dom.ed.addEventListener('input', syncLayout);
    dom.ed.addEventListener('scroll', () => { dom.gut.scrollTop = dom.ed.scrollTop; });
    window.addEventListener('resize', syncLayout);
    // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å (–µ—Å–ª–∏ —Å–∫—Ä–æ–ª–ª–±–∞—Ä –ø–æ—è–≤–∏—Ç—Å—è, —à–∏—Ä–∏–Ω–∞ –∏–∑–º–µ–Ω–∏—Ç—Å—è - –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º)
    new ResizeObserver(syncLayout).observe(dom.ed);


    // --- –û–°–¢–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
    function clean() {
        dom.ed.value = ''; fileH = null; dom.tab.textContent = '---'; 
        dom.stat.textContent='–û—á–∏—â–µ–Ω–æ'; syncLayout();
    }

    async function chooseFolder() {
        try {
            const h = await window.showDirectoryPicker();
            folderH = h; isDir = true; clean();
            dom.tit.textContent = h.name.toUpperCase();
            render();
            dom.stat.textContent='–ü–∞–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞';
        } catch(e){}
    }

    async function chooseFiles() {
        try {
            const arr = await window.showOpenFilePicker({
                multiple:true, types:[{description:'Code',accept:{'text/plain':['.prsh','.prshx','.txt']}}]
            });
            clean();
            handlesCache = arr; isDir = false; folderH = null;
            dom.tit.textContent = "–í–´–ë–†–ê–ù–ù–´–ï –§–ê–ô–õ–´";
            render();
            dom.stat.textContent='–§–∞–π–ª–æ–≤: ' + arr.length;
        } catch(e){}
    }

    async function render() {
        dom.list.innerHTML='';
        const arr = [];
        if(isDir && folderH) {
            for await (const [n,h] of folderH.entries()) {
                if(h.kind=='file' && n.toUpperCase().match(/\.(PRSH|PRSHX|TXT)$/)) arr.push(h);
            }
        } else if(!isDir) {
            arr.push(...handlesCache);
        }
        if(arr.length==0) return dom.list.innerHTML='<li style="padding:15px;color:#666;text-align:center">–ü—É—Å—Ç–æ</li>';

        arr.sort((a,b)=>a.name.localeCompare(b.name)).forEach(h => {
            const li = document.createElement('li');
            li.className='file-item';
            const ico = h.name.match(/\.PRSHX/i) ? 'üß©':'üìÑ';
            li.innerHTML = `<span>${ico} ${h.name}</span> <span class="del-btn">‚úï</span>`;
            li.onclick = (e) => {
                if(e.target.className=='del-btn') return;
                loadFile(h);
                document.querySelectorAll('.file-item').forEach(x=>x.classList.remove('active'));
                li.classList.add('active');
            }
            li.querySelector('.del-btn').onclick = async () => {
                if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
                if(isDir) await folderH.removeEntry(h.name);
                else handlesCache = handlesCache.filter(x=>x!==h);
                if(fileH && fileH.name==h.name) clean();
                render();
            };
            dom.list.appendChild(li);
        });
    }

    async function loadFile(h) {
        try {
            fileH = h;
            const f = await h.getFile();
            dom.ed.value = await f.text();
            dom.tab.textContent = h.name;
            dom.stat.textContent = h.name;
            // –ö–æ—Å—Ç—ã–ª—å, —á—Ç–æ–±—ã —Ä–µ–Ω–¥–µ—Ä —à—Ä–∏—Ñ—Ç–∞ —É—Å–ø–µ–ª –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º
            setTimeout(syncLayout, 0); 
        } catch(e){alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è')}
    }

    async function saveDoc() {
        if(!fileH) return alert('–ù–µ—Ç —Ñ–∞–π–ª–∞');
        try {
            const w = await fileH.createWritable();
            await w.write(dom.ed.value);
            await w.close();
            dom.stat.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            setTimeout(()=>dom.stat.textContent='...', 2000);
        } catch(e){alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')}
    }

    function newFileAsk() {
        if(!isDir) return alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É —Å–Ω–∞—á–∞–ª–∞');
        dom.mod.style.display='flex';
        dom.inp.value=''; dom.inp.focus();
    }
    
    async function createYes() {
        let n = dom.inp.value.trim();
        if(!n) return;
        if(!n.toUpperCase().match(/\.(PRSH|PRSHX)$/)) n+='.PRSH';
        try {
            const nh = await folderH.getFileHandle(n, {create:true});
            const w = await nh.createWritable();
            await w.write(`–ø—Ä–∏–≤–µ—Ç —Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ chatGPT {\n    \n}`); 
            await w.close();
            dom.mod.style.display='none';
            await render();
            loadFile(nh);
        } catch(e){alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è')}
    }

    document.addEventListener('keydown', e=>{
        if(e.ctrlKey && e.key=='s'){e.preventDefault();saveDoc();}
    });
</script>
</body>
</html>
